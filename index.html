<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLIT-HUB | Learn. Connect. Trade.</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SLIT-HUB">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=SH&background=10b981&color=fff&size=192">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ========== PROFESSIONAL DESIGN SYSTEM ========== */
        :root { 
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-light: #34d399;
            --primary-glow: rgba(16, 185, 129, 0.3);
            --secondary: #6366f1;
            --accent: #8b5cf6;
            --bg: #f8fafc; 
            --card: #ffffff; 
            --text: #1e293b; 
            --text-light: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0; 
            --input-bg: #f1f5f9;
            --nav-text: #64748b;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --gold: #fbbf24;
            --gold-dark: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        html.dark { 
            --bg: #0f172a; 
            --card: #1e293b; 
            --text: #f8fafc; 
            --text-light: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155; 
            --input-bg: #1e293b;
            --nav-text: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            padding-bottom: 90px;
            background: var(--bg);
            color: var(--text); 
            transition: background 0.3s ease, color 0.3s ease; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* ========== TYPOGRAPHY ========== */
        h1 { font-size: 2rem; font-weight: 800; letter-spacing: -0.02em; }
        h2 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.01em; }
        h3 { font-size: 1.25rem; font-weight: 600; }
        p { font-size: 0.95rem; color: var(--text-light); line-height: 1.5; }

        /* ========== TEXT COLORS ========== */
        .text-default { color: var(--text) !important; }
        .text-light { color: var(--text-light) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .bg-card { background-color: var(--card) !important; }
        .border-base { border-color: var(--border) !important; }
        .bg-input { background-color: var(--input-bg) !important; }

        /* ========== INPUT STYLES ========== */
        input, textarea, select {
            background-color: var(--input-bg) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
            border-radius: 12px !important;
            padding: 12px 16px !important;
            font-size: 0.95rem !important;
            transition: all 0.2s ease !important;
            width: 100%;
        }
        input:focus, textarea:focus, select:focus {
            outline: none !important;
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px var(--primary-glow) !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-muted) !important;
            opacity: 0.7;
        }
        .input-error {
            border-color: var(--danger) !important;
        }
        .error-message {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }

        /* ========== PHONE INPUT ========== */
        .phone-input-container {
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .phone-prefix {
            background: var(--primary);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            border-right: 1px solid var(--border);
        }
        .phone-input-container input {
            border: none !important;
            border-radius: 0 !important;
            flex: 1;
        }

        /* ========== BRANDING ========== */
        .brand-logo {
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.2));
            cursor: pointer;
            transition: transform 0.2s;
        }
        .brand-logo:active { transform: scale(0.95); }

        .tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .btn:active::after {
            width: 200px;
            height: 200px;
        }
        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--primary-glow);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover {
            background: var(--input-bg);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
        }
        .btn-whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
        }

        .btn-call {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-call:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== BADGES ========== */
        .gold-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }

        .gold-check {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            margin-left: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .blue-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .blue-check {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            margin-left: 4px;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            gap: 6px;
        }

        .unverified-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            gap: 6px;
        }

        /* ========== CARDS ========== */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .product-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: var(--shadow);
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        /* ========== NAVIGATION ========== */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 8px 16px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--nav-text);
            transition: all 0.2s;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 12px;
        }
        .nav-item i {
            font-size: 1.3rem;
            transition: transform 0.2s;
        }
        .nav-item:hover {
            color: var(--primary);
            background: var(--input-bg);
        }
        .nav-item:hover i {
            transform: translateY(-2px);
        }
        .nav-item.active-nav {
            color: var(--primary);
            background: var(--primary-glow);
        }
        .nav-item.active-nav i {
            transform: scale(1.1);
        }

        /* ========== TABS ========== */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar {
            display: none;
        }
        .tab {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.2s;
            background: none;
            border: none;
            font-size: 0.9rem;
        }
        .tab:hover {
            background: var(--input-bg);
            color: var(--text);
        }
        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        /* ========== NOTIFICATIONS ========== */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid var(--card);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: var(--card);
            border-left: 4px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            box-shadow: var(--shadow-xl);
            z-index: 10000;
            animation: slideUp 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ========== SCAM WARNING ========== */
        .scam-warning {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-left: 4px solid #ef4444;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            color: #7f1d1d;
        }
        .dark .scam-warning {
            background: linear-gradient(135deg, #7f1d1d, #991b1b);
            color: #fee2e2;
        }

        /* ========== LEVEL BADGES ========== */
        .level-badge {
            display: inline-flex;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            margin-left: 4px;
        }
        .level-100 { background: #3b82f6; }
        .level-200 { background: #10b981; }
        .level-300 { background: #f59e0b; }
        .level-400 { background: #ef4444; }
        .level-500 { background: #8b5cf6; }

        /* ========== GRID ========== */
        .grid-2, .grid-3, .grid-4 {
            display: grid;
            gap: 1.5rem;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        .hidden {
            display: none !important;
        }

        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 100000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            animation: fadeIn 0.2s ease;
        }
        .modal-content {
            background: var(--card);
            border-radius: 24px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            box-shadow: var(--shadow-xl);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* ========== INSTALL BUTTON ========== */
        #install-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            font-weight: bold;
            box-shadow: 0 4px 20px var(--primary-glow);
            cursor: pointer;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        #install-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px var(--primary-glow);
        }

        /* ========== RATING STARS ========== */
        .star-rating {
            display: flex;
            gap: 4px;
        }
        .star-rating i {
            color: #fbbf24;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .star-rating i:hover {
            transform: scale(1.2);
        }
        .star-rating i.inactive {
            color: var(--border);
        }

        /* ========== PRICE FORMATTING ========== */
        .price-input {
            position: relative;
        }
        .price-input input {
            padding-left: 30px !important;
        }
        .price-input::before {
            content: '‚Ç¶';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-weight: 600;
            z-index: 1;
        }

        /* ========== LOADING SKELETON ========== */
        .skeleton {
            background: linear-gradient(90deg, var(--border) 25%, var(--input-bg) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ========== PRIVACY TOGGLE ========== */
        .privacy-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .privacy-toggle input {
            width: auto;
            margin-right: 4px;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-card border-b border-base p-4 backdrop-blur-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="brand-logo text-2xl" id="logo-home">SLIT-HUB</h1>
                <p class="tagline hidden md:block">Learn. Connect. Trade. ‚Äî Everything SLIT, One Place</p>
            </div>
            <div class="flex items-center gap-3">
                <!-- Portfolio Link -->
                <a href="#" id="portfolio-link" target="_blank" class="hidden md:flex items-center gap-2 text-primary hover:underline">
                    <i class="fas fa-briefcase"></i> Creator's Portfolio
                </a>
                <button id="dark-mode-toggle" class="w-10 h-10 rounded-xl bg-input flex items-center justify-center hover:bg-opacity-80 transition">
                    <i class="fas fa-moon" id="dark-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Global Broadcast -->
    <div id="global-broadcast" class="hidden bg-warning text-white p-2 text-center font-bold">
        <i class="fas fa-bullhorn"></i> <span id="broadcast-message"></span>
    </div>

    <!-- Main Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 mt-4">
        <div class="tabs">
            <button class="tab active" data-tab="home">üè† Home</button>
            <button class="tab" data-tab="academics">üìö Learn</button>
            <button class="tab" data-tab="community">üë• Connect</button>
            <button class="tab" data-tab="marketplace">üõçÔ∏è Trade</button>
            <button class="tab" data-tab="profile">üë§ Profile</button>
            <button class="tab" data-tab="manager">üìã Manager</button>
            <button class="tab" data-tab="admin">‚öôÔ∏è Admin</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4">
        
        <!-- HOME TAB -->
        <section id="home-tab" class="tab-content">
            <div class="mb-8">
                <h2 class="text-2xl font-bold">Welcome back, <span id="home-user-name">Student</span>!</h2>
                <p class="text-muted" id="home-user-details">SLIT ‚Ä¢ Set your department in profile</p>
            </div>

            <!-- Quick Stats - Clickable -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-nav="academics">
                    <div class="text-4xl mb-2 text-primary">üìö</div>
                    <div class="text-2xl font-bold" id="stat-courses">0</div>
                    <div class="text-xs text-muted">Courses</div>
                </div>
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-nav="community">
                    <div class="text-4xl mb-2 text-warning">üì¢</div>
                    <div class="text-2xl font-bold" id="stat-announcements">0</div>
                    <div class="text-xs text-muted">Announcements</div>
                </div>
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-nav="marketplace">
                    <div class="text-4xl mb-2 text-success">üõçÔ∏è</div>
                    <div class="text-2xl font-bold" id="stat-items">0</div>
                    <div class="text-xs text-muted">Items for Sale</div>
                </div>
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-nav="community">
                    <div class="text-4xl mb-2 text-info">üë•</div>
                    <div class="text-2xl font-bold" id="stat-execs">0</div>
                    <div class="text-xs text-muted">Executives</div>
                </div>
            </div>

            <!-- Today's Schedule -->
            <div class="card mb-8 cursor-pointer hover:shadow-xl" data-nav="academics">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-day text-primary"></i> Today's Schedule
                </h3>
                <div id="today-schedule" class="space-y-3">
                    <p class="text-muted text-center py-4">Click to view your timetable</p>
                </div>
            </div>

            <!-- Latest Announcements -->
            <div class="card cursor-pointer hover:shadow-xl" data-nav="community">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-bullhorn text-primary"></i> Latest Announcements
                    </h3>
                    <span class="text-primary hover:underline">View All ‚Üí</span>
                </div>
                <div id="home-announcements" class="space-y-3"></div>
            </div>
        </section>

        <!-- ACADEMICS TAB -->
        <section id="academics-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">üìö Learn</h2>
                <p class="text-muted">School of Logistics and Innovation Technology</p>
            </div>

            <!-- Department Selector -->
            <div class="card mb-6">
                <label class="block text-sm font-bold mb-2">Your Department</label>
                <select id="academics-dept" class="input-field w-full md:w-96">
                    <option value="">Select Department</option>
                </select>
            </div>

            <!-- Quick Access Cards - Clickable -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-academics="lecture">
                    <div class="text-4xl mb-2">üìñ</div>
                    <div class="font-bold">Lectures</div>
                    <div class="text-xs text-muted">Weekly schedule</div>
                </div>
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-academics="test">
                    <div class="text-4xl mb-2">üìù</div>
                    <div class="font-bold">Tests</div>
                    <div class="text-xs text-muted">Upcoming tests</div>
                </div>
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-academics="exam">
                    <div class="text-4xl mb-2">üìã</div>
                    <div class="font-bold">Exams</div>
                    <div class="text-xs text-muted">Exam schedule</div>
                </div>
                <div class="card text-center cursor-pointer hover:shadow-xl transition transform hover:-translate-y-1" data-academics="materials">
                    <div class="text-4xl mb-2">üìö</div>
                    <div class="font-bold">Materials</div>
                    <div class="text-xs text-muted">Past questions</div>
                </div>
            </div>

            <!-- Timetable Display -->
            <div id="timetable-container" class="card mb-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="timetable-title" class="font-bold">Lecture Timetable</h3>
                    <button id="hide-timetable" class="text-muted hover:text-danger"><i class="fas fa-times"></i></button>
                </div>
                <div id="timetable-content" class="space-y-3"></div>
            </div>

            <!-- Study Groups -->
            <div class="card mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-users text-primary"></i> Study Groups
                    </h3>
                    <button id="create-study-group" class="btn-primary text-sm py-2">+ Create Group</button>
                </div>
                <div id="study-groups" class="space-y-3"></div>
            </div>

            <!-- Course Materials -->
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-folder-open text-primary"></i> Course Materials
                    </h3>
                    <button id="upload-material" class="btn-primary text-sm py-2">+ Upload</button>
                </div>
                <div id="materials-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- COMMUNITY TAB -->
        <section id="community-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">üë• Connect</h2>
                <p class="text-muted">Stay connected with your department community</p>
            </div>

            <!-- Announcement Categories -->
            <div class="flex gap-2 overflow-x-auto pb-4 mb-6 scrollbar-hide">
                <button class="category-btn px-4 py-2 bg-primary text-white rounded-full text-sm font-bold" data-category="all">All</button>
                <button class="category-btn px-4 py-2 bg-card border border-base rounded-full text-sm" data-category="sports">‚öΩ Sports</button>
                <button class="category-btn px-4 py-2 bg-card border border-base rounded-full text-sm" data-category="social">üéâ Social</button>
                <button class="category-btn px-4 py-2 bg-card border border-base rounded-full text-sm" data-category="academic">üìö Academic</button>
                <button class="category-btn px-4 py-2 bg-card border border-base rounded-full text-sm" data-category="media">üì∏ Media</button>
            </div>

            <!-- Executive Post Card -->
            <div id="executive-post-card" class="card mb-6 hidden">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-pen-fancy text-primary text-xl"></i>
                    <span class="font-bold">Post Announcement</span>
                    <span id="executive-badge" class="gold-badge ml-auto"><i class="fas fa-check-circle"></i> Executive</span>
                </div>
                <div class="space-y-3">
                    <select id="announce-category" class="input-field">
                        <option value="sports">‚öΩ Sports</option>
                        <option value="social">üéâ Social</option>
                        <option value="academic">üìö Academic</option>
                        <option value="media">üì∏ Media</option>
                    </select>
                    <input type="text" id="announce-title" placeholder="Title" class="input-field">
                    <textarea id="announce-content" placeholder="Content..." rows="3" class="input-field"></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="announce-link" placeholder="Link (optional)" class="input-field">
                        <input type="date" id="announce-date" class="input-field">
                    </div>
                    <button id="publish-announcement" class="btn-primary w-full">Publish Announcement</button>
                </div>
            </div>

            <!-- Announcements Feed -->
            <div id="announcements-feed" class="space-y-4 mb-8"></div>

            <!-- Executives Directory -->
            <div class="card mb-8">
                <h3 class="font-bold mb-4">Department Executives</h3>
                <div id="executives-directory" class="space-y-3"></div>
            </div>

            <!-- Media Gallery -->
            <div class="card">
                <h3 class="font-bold mb-4">üì∏ Media Gallery</h3>
                <div id="media-gallery" class="grid grid-cols-3 gap-2"></div>
            </div>
        </section>

        <!-- MARKETPLACE TAB -->
        <section id="marketplace-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">üõçÔ∏è Trade</h2>
                <p class="text-muted">Buy, sell, and request services on campus</p>
            </div>

            <!-- Scam Warning -->
            <div class="scam-warning mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-shield-alt text-2xl"></i>
                    <div>
                        <p class="font-bold mb-1">‚ö†Ô∏è Safety Tips:</p>
                        <p class="text-sm">‚Ä¢ Meet in public places (library, cafeteria)</p>
                        <p class="text-sm">‚Ä¢ Never send money in advance</p>
                        <p class="text-sm">‚Ä¢ Inspect items before payment</p>
                        <p class="text-sm">‚Ä¢ Report suspicious users immediately</p>
                    </div>
                </div>
            </div>

            <!-- Marketplace Sub-tabs -->
            <div class="flex gap-2 border-b border-base mb-6">
                <button class="sub-tab px-4 py-2 font-bold text-primary border-b-2 border-primary" data-marketplace="shop">üõí Shop</button>
                <button class="sub-tab px-4 py-2 text-muted" data-marketplace="services">üõ†Ô∏è Services</button>
                <button class="sub-tab px-4 py-2 text-muted" data-marketplace="requests">üôã Requests</button>
            </div>

            <!-- Shop Section -->
            <div id="shop-section" class="marketplace-section">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Recent Items</h3>
                    <button id="sell-item" class="btn-primary text-sm py-2">+ Sell Item</button>
                </div>
                <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- Services Section -->
            <div id="services-section" class="marketplace-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Campus Services</h3>
                    <button id="list-service" class="btn-primary text-sm py-2">+ List Service</button>
                </div>

                <!-- Service Categories -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="card text-center cursor-pointer hover:shadow-lg" data-service="hair">
                        <div class="text-3xl mb-1">‚úÇÔ∏è</div>
                        <div class="text-xs font-bold">Hair & Beauty</div>
                    </div>
                    <div class="card text-center cursor-pointer hover:shadow-lg" data-service="repair">
                        <div class="text-3xl mb-1">üì±</div>
                        <div class="text-xs font-bold">Gadget Repair</div>
                    </div>
                    <div class="card text-center cursor-pointer hover:shadow-lg" data-service="photo">
                        <div class="text-3xl mb-1">üì∏</div>
                        <div class="text-xs font-bold">Photography</div>
                    </div>
                    <div class="card text-center cursor-pointer hover:shadow-lg" data-service="tutor">
                        <div class="text-3xl mb-1">üë®‚Äçüè´</div>
                        <div class="text-xs font-bold">Tutoring</div>
                    </div>
                </div>

                <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <!-- Requests Section -->
            <div id="requests-section" class="marketplace-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Community Requests</h3>
                    <button id="new-request" class="btn-primary text-sm py-2">+ New Request</button>
                </div>

                <!-- Request Categories -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-4">
                    <button class="category-btn px-3 py-1 bg-primary text-white rounded-full text-xs" data-request="all">All</button>
                    <button class="category-btn px-3 py-1 bg-card border border-base rounded-full text-xs" data-request="roommate">üè† Roommate</button>
                    <button class="category-btn px-3 py-1 bg-card border border-base rounded-full text-xs" data-request="study">üë´ Study Partner</button>
                    <button class="category-btn px-3 py-1 bg-card border border-base rounded-full text-xs" data-request="textbook">üìö Textbook</button>
                    <button class="category-btn px-3 py-1 bg-card border border-base rounded-full text-xs" data-request="urgent">üöë Urgent</button>
                </div>

                <div id="requests-grid" class="space-y-4"></div>
            </div>
        </section>

        <!-- PROFILE TAB -->
        <section id="profile-tab" class="tab-content hidden max-w-2xl mx-auto">
            <div class="card">
                <div class="text-center mb-8">
                    <div class="relative inline-block">
                        <img id="profile-pic" src="https://ui-avatars.com/api/?name=User&background=10b981&color=fff&size=128" class="w-28 h-28 rounded-full mx-auto border-4 border-white shadow-lg cursor-pointer" id="change-profile-pic">
                        <button id="upload-profile-pic" class="absolute bottom-0 right-0 bg-primary text-white p-2.5 rounded-full text-xs border-2 border-white hover:bg-primary-dark transition">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <input type="file" id="profile-upload" class="hidden" accept="image/*">
                    
                    <h2 id="profile-name" class="text-2xl font-bold mt-4">Your Name</h2>
                    <p class="text-sm text-muted">ID: <span id="profile-id"></span></p>
                    
                    <!-- Badges & Verification Status -->
                    <div id="profile-badges" class="flex justify-center gap-2 mt-2 flex-wrap"></div>
                    <div id="profile-verification-status" class="mt-2"></div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Full Name <span class="text-danger">*</span></label>
                        <input type="text" id="profile-name-input" class="input-field" placeholder="Enter your full name">
                        <div class="error-message" id="name-error">Name is required</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Email <span class="text-danger">*</span></label>
                        <input type="email" id="profile-email" class="input-field" placeholder="your.email@university.edu.ng">
                    </div>
                    
                    <!-- Phone with +234 prefix -->
                    <div>
                        <label class="block text-sm font-bold mb-1">Phone Number</label>
                        <div class="phone-input-container">
                            <span class="phone-prefix">+234</span>
                            <input type="tel" id="profile-phone" class="input-field" placeholder="8012345678" style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Department</label>
                        <select id="profile-dept" class="input-field"></select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Level</label>
                        <select id="profile-level" class="input-field">
                            <option value="">Select Level</option>
                            <option value="100">100 Level</option>
                            <option value="200">200 Level</option>
                            <option value="300">300 Level</option>
                            <option value="400">400 Level</option>
                            <option value="500">500 Level</option>
                        </select>
                    </div>
                    
                    <!-- Privacy Settings -->
                    <div class="border-t border-base pt-4">
                        <h3 class="font-bold mb-3">üîí Privacy Settings</h3>
                        <div class="space-y-2">
                            <label class="privacy-toggle flex items-center">
                                <input type="checkbox" id="hide-email" class="w-4 h-4 mr-2">
                                <span class="text-sm">Hide my email from other users</span>
                            </label>
                            <label class="privacy-toggle flex items-center">
                                <input type="checkbox" id="hide-dept" class="w-4 h-4 mr-2">
                                <span class="text-sm">Hide my department from other users</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Bio</label>
                        <textarea id="profile-bio" rows="3" class="input-field" placeholder="Tell us about yourself..."></textarea>
                    </div>

                    <button id="save-profile" class="btn-primary w-full">
                        <i class="fas fa-save"></i> Save Profile
                    </button>

                    <!-- Contact Developer/Admin -->
                    <div class="border-t border-base pt-4 mt-4">
                        <h3 class="font-bold mb-3">Need Help?</h3>
                        <div class="flex gap-3">
                            <a href="https://wa.me/2348053103234" target="_blank" class="flex-1 btn-whatsapp py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                <i class="fab fa-whatsapp"></i> Contact Developer
                            </a>
                            <button id="contact-admin" class="flex-1 btn-primary py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-envelope"></i> Message Admin
                            </button>
                        </div>
                    </div>

                    <!-- Creator's Portfolio Section -->
                    <div class="border-t border-base pt-4 mt-4">
                        <h3 class="font-bold mb-3 text-primary">üé® Creator's Works</h3>
                        <div class="flex gap-3">
                            <input type="text" id="portfolio-url" class="input-field flex-1" placeholder="Portfolio URL" value="https://yourportfolio.com">
                            <input type="text" id="portfolio-image" class="input-field flex-1" placeholder="Portfolio Image URL">
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button id="save-portfolio" class="btn-outline flex-1">Save Links</button>
                            <a href="#" id="portfolio-link-button" target="_blank" class="btn-primary flex-1 flex items-center justify-center gap-2">
                                <i class="fas fa-external-link-alt"></i> View Portfolio
                            </a>
                        </div>
                    </div>

                    <!-- Upload ID for Verification -->
                    <div class="border-t border-base pt-4 mt-4">
                        <h3 class="font-bold mb-3 text-green-600">‚úÖ Get Verified</h3>
                        <button id="request-verification" class="w-full btn-success py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-id-card"></i> Upload Student ID for Verification
                        </button>
                    </div>

                    <!-- Upload Course Materials (for Course Reps) -->
                    <div id="course-rep-upload" class="border-t border-base pt-4 mt-4 hidden">
                        <h3 class="font-bold mb-3 text-blue-600">üìò Course Rep Tools</h3>
                        <button id="rep-upload-material" class="w-full btn-primary py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-upload"></i> Upload Course Materials
                        </button>
                    </div>

                    <!-- Delete Profile -->
                    <div class="border-t border-base pt-4 mt-4">
                        <button id="delete-profile" class="w-full btn-danger py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i> Delete Profile
                        </button>
                        <p class="text-xs text-muted text-center mt-2">This action cannot be undone</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- MANAGER TAB (My Items) -->
        <section id="manager-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üìã My Items</h2>
                <button id="add-new-item" class="btn-primary text-sm py-2">+ Add New</button>
            </div>
            <div id="my-items-grid" class="grid grid-cols-1 gap-4"></div>
        </section>

        <!-- ADMIN TAB -->
        <section id="admin-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Admin Dashboard</h2>
                <button id="admin-toggle" class="px-4 py-2 bg-card border border-base rounded-xl text-sm hover:bg-input transition">
                    <i class="fas fa-lock"></i> Admin: OFF
                </button>
            </div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="hidden space-y-6">
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-4 rounded-xl text-white shadow-lg">
                        <div class="text-3xl font-bold" id="admin-stat-depts">0</div>
                        <div class="text-sm opacity-90">Departments</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-4 rounded-xl text-white shadow-lg">
                        <div class="text-3xl font-bold" id="admin-stat-execs">0</div>
                        <div class="text-sm opacity-90">Executives</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-xl text-white shadow-lg">
                        <div class="text-3xl font-bold" id="admin-stat-users">0</div>
                        <div class="text-sm opacity-90">Users</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-4 rounded-xl text-white shadow-lg">
                        <div class="text-3xl font-bold" id="admin-stat-products">0</div>
                        <div class="text-sm opacity-90">Products</div>
                    </div>
                </div>

                <!-- Portfolio Links Management -->
                <div class="card">
                    <h3 class="font-bold mb-4 text-primary">üé® Creator Portfolio</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <input type="text" id="admin-portfolio-url" placeholder="Portfolio URL" class="input-field">
                        <input type="text" id="admin-portfolio-image" placeholder="Portfolio Image URL" class="input-field">
                    </div>
                    <button id="admin-save-portfolio" class="btn-primary">Save Portfolio Links</button>
                </div>

                <!-- Global Broadcast -->
                <div class="bg-gradient-to-r from-primary to-emerald-600 p-6 rounded-2xl text-white shadow-lg">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-bullhorn"></i> Global Broadcast
                    </h3>
                    <textarea id="global-broadcast-input" class="w-full p-3 rounded-xl text-gray-900 mb-3" rows="2" placeholder="Type broadcast message..."></textarea>
                    <div class="flex gap-3">
                        <button id="send-broadcast" class="bg-white text-primary px-6 py-2 rounded-xl font-bold hover:shadow-lg transition">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                        <button id="delete-broadcast" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-600 transition">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <!-- User Verification Management -->
                <div class="card">
                    <h3 class="font-bold mb-4 text-green-600">‚úÖ User Verification</h3>
                    <div id="verification-list" class="space-y-3"></div>
                </div>

                <!-- All Users with Verification Status -->
                <div class="card">
                    <h3 class="font-bold mb-4 text-blue-600">üë• All Users (Admin View)</h3>
                    <div id="member-directory-admin" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>

                <!-- Department Management -->
                <div class="card">
                    <h3 class="font-bold mb-4 text-primary">üèõÔ∏è Department Management</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <input type="text" id="dept-name" placeholder="Department Name (e.g., PMT)" class="input-field">
                        <input type="text" id="dept-code" placeholder="Code (e.g., PMT)" class="input-field">
                        <button id="add-dept" class="btn-primary">
                            <i class="fas fa-plus"></i> Add Department
                        </button>
                    </div>
                    
                    <div id="depts-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Executive Management -->
                <div class="card">
                    <h3 class="font-bold mb-4 text-yellow-600">‚≠ê Executive Management</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <select id="exec-dept" class="input-field">
                            <option value="">Select Department</option>
                        </select>
                        <input type="text" id="exec-name" placeholder="Full Name" class="input-field">
                        <input type="text" id="exec-position" placeholder="Position" class="input-field">
                        <input type="email" id="exec-email" placeholder="Email" class="input-field">
                        <select id="exec-level" class="input-field">
                            <option value="faculty">üëë Faculty Executive</option>
                            <option value="department">‚≠ê Department Executive</option>
                            <option value="course">üìò Course Representative</option>
                        </select>
                        <input type="text" id="exec-course" placeholder="Course Code (if rep)" class="input-field">
                        <button id="add-exec" class="btn-warning col-span-3">
                            <i class="fas fa-plus"></i> Add Executive
                        </button>
                    </div>
                    
                    <div id="execs-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Reports -->
                <div class="card">
                    <h3 class="font-bold mb-4 text-red-600">‚ö†Ô∏è Reports</h3>
                    <div id="reports-list" class="space-y-3"></div>
                </div>

                <!-- Danger Zone -->
                <div class="card border-2 border-danger">
                    <h3 class="font-bold mb-4 text-danger">‚ö†Ô∏è Danger Zone</h3>
                    <button id="delete-all-data" class="btn-danger w-full">
                        <i class="fas fa-exclamation-triangle"></i> Delete All Data (Requires Super Admin)
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="nav-bar">
        <button class="nav-item" data-nav="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" data-nav="academics">
            <i class="fas fa-book-open"></i>
            <span>Learn</span>
        </button>
        <button class="nav-item" data-nav="community">
            <i class="fas fa-users"></i>
            <span>Connect</span>
        </button>
        <button class="nav-item" data-nav="marketplace">
            <i class="fas fa-store"></i>
            <span>Trade</span>
        </button>
        <button class="nav-item" data-nav="profile">
            <i class="fas fa-user-circle"></i>
            <span>Profile</span>
        </button>
        <button class="nav-item" data-nav="manager">
            <i class="fas fa-clipboard-list"></i>
            <span>Manager</span>
        </button>
    </nav>

    <!-- Install Button -->
    <button id="install-btn">
        <i class="fas fa-download"></i> Install Slit-Hub
    </button>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, query, orderBy, onSnapshot, where, serverTimestamp, doc, getDoc, deleteDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCpsDTN-NTkTFmbwg3T6vv9H4eE_YXQdZA",
            authDomain: "slit-hub.firebaseapp.com",
            projectId: "slit-hub",
            storageBucket: "slit-hub.firebasestorage.app",
            messagingSenderId: "347194010969",
            appId: "1:347194010969:web:a45af2e8d1627ac2593048"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============ GLOBAL VARIABLES ============
        let currentUserId = localStorage.getItem('slit_user_id');
        if (!currentUserId) {
            currentUserId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 9999);
            localStorage.setItem('slit_user_id', currentUserId);
        }

        let isAdminMode = false;
        let currentUserData = null;
        let verifiedUsers = new Set();
        let portfolioUrl = localStorage.getItem('portfolio_url') || '';
        let portfolioImage = localStorage.getItem('portfolio_image') || '';

        // ============ UTILITY FUNCTIONS ============
        function formatPrice(price) {
            return new Intl.NumberFormat('en-NG').format(price);
        }

        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast-container');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast';
            toastEl.style.borderLeftColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b';
            toastEl.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-xl">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</div>
                    <div class="flex-1">
                        <p class="font-bold">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-muted hover:text-text">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            toast.appendChild(toastEl);
            setTimeout(() => toastEl.remove(), duration);
        }

        function showLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            }
        }

        function hideLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // ============ MAKE ALL FUNCTIONS GLOBALLY ACCESSIBLE ============
        window.formatPrice = formatPrice;
        window.showToast = showToast;
        window.showLoading = showLoading;
        window.hideLoading = hideLoading;

        // ============ LOAD VERIFIED USERS ============
        async function loadVerifiedUsers() {
            try {
                const snap = await getDocs(collection(db, "VerifiedUsers"));
                verifiedUsers.clear();
                snap.forEach(doc => verifiedUsers.add(doc.id));
            } catch (e) {
                console.error("Error loading verified users:", e);
            }
        }
        window.loadVerifiedUsers = loadVerifiedUsers;

        // ============ TAB SWITCHING ============
        function switchTab(tabId) {
            console.log('Switching to tab:', tabId);
            
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active-nav'));
            
            const tabs = document.querySelectorAll('.tab');
            const navItems = document.querySelectorAll('.nav-item');
            
            const tabIndex = {
                'home': 0, 'academics': 1, 'community': 2, 
                'marketplace': 3, 'profile': 4, 'manager': 5, 'admin': 6
            }[tabId];
            
            if (tabs[tabIndex]) tabs[tabIndex].classList.add('active');
            if (navItems[tabIndex]) navItems[tabIndex].classList.add('active-nav');
            
            // Load tab data
            if (tabId === 'home') loadHomeData();
            if (tabId === 'academics') loadAcademicsData();
            if (tabId === 'community') loadCommunityData();
            if (tabId === 'marketplace') loadMarketplaceData();
            if (tabId === 'profile') loadProfileData();
            if (tabId === 'manager') loadMyItems();
            if (tabId === 'admin' && isAdminMode) loadAdminData();
        }
        window.switchTab = switchTab;

        function switchMarketplaceTab(tab) {
            console.log('Switching marketplace tab to:', tab);
            
            document.querySelectorAll('.marketplace-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${tab}-section`).classList.remove('hidden');
            
            document.querySelectorAll('.sub-tab').forEach(t => {
                t.classList.remove('text-primary', 'border-b-2', 'border-primary');
                t.classList.add('text-muted');
            });
            
            const activeTab = document.querySelector(`[data-marketplace="${tab}"]`);
            if (activeTab) {
                activeTab.classList.add('text-primary', 'border-b-2', 'border-primary');
            }
            
            if (tab === 'shop') loadProducts();
            if (tab === 'services') loadServices();
            if (tab === 'requests') loadRequests();
        }
        window.switchMarketplaceTab = switchMarketplaceTab;

        // ============ HOME TAB ============
        async function loadHomeData() {
            try {
                await loadVerifiedUsers();
                
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                if (userSnap.exists()) {
                    currentUserData = userSnap.data();
                    document.getElementById('home-user-name').innerText = currentUserData.name || 'Student';
                    
                    let deptName = 'SLIT';
                    if (currentUserData.dept) {
                        const deptSnap = await getDoc(doc(db, "departments", currentUserData.dept));
                        if (deptSnap.exists()) deptName = deptSnap.data().name;
                    }
                    
                    document.getElementById('home-user-details').innerHTML = 
                        `${deptName} ‚Ä¢ ${currentUserData.level || 'Set level in profile'}`;
                }
                
                // Load stats
                const deptsSnap = await getDocs(collection(db, "departments"));
                const execsSnap = await getDocs(collection(db, "executives"));
                const productsSnap = await getDocs(collection(db, "Products"));
                const announcementsSnap = await getDocs(collection(db, "announcements"));
                
                document.getElementById('stat-courses').innerText = deptsSnap.size;
                document.getElementById('stat-announcements').innerText = announcementsSnap.size;
                document.getElementById('stat-items').innerText = productsSnap.size;
                document.getElementById('stat-execs').innerText = execsSnap.size;
                
                // Load recent announcements
                const recentAnn = await getDocs(query(
                    collection(db, "announcements"),
                    orderBy("createdAt", "desc"),
                    limit(3)
                ));
                
                let annHtml = '';
                recentAnn.forEach(doc => {
                    const ann = doc.data();
                    annHtml += `
                        <div class="p-3 bg-input rounded-lg cursor-pointer hover:bg-opacity-80 transition" onclick="viewAnnouncement('${doc.id}')">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-primary">${ann.category}</span>
                                <span class="text-xs text-muted">${ann.createdAt ? new Date(ann.createdAt.seconds*1000).toLocaleDateString() : ''}</span>
                            </div>
                            <p class="font-bold text-sm">${ann.title}</p>
                        </div>
                    `;
                });
                document.getElementById('home-announcements').innerHTML = annHtml || '<p class="text-muted">No recent announcements</p>';
            } catch (e) {
                console.error("Error loading home data:", e);
            }
        }
        window.loadHomeData = loadHomeData;

        // ============ PROFILE ============
        async function loadProfileData() {
            try {
                await loadVerifiedUsers();
                
                document.getElementById('profile-id').innerText = currentUserId;
                
                // Load departments
                const deptsSnap = await getDocs(collection(db, "departments"));
                let deptOptions = '<option value="">Select Department</option>';
                deptsSnap.forEach(doc => {
                    const dept = doc.data();
                    deptOptions += `<option value="${doc.id}">${dept.name}</option>`;
                });
                document.getElementById('profile-dept').innerHTML = deptOptions;
                
                // Load user data
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                if (userSnap.exists()) {
                    const user = userSnap.data();
                    currentUserData = user;
                    
                    document.getElementById('profile-name').innerText = user.name || 'Your Name';
                    document.getElementById('profile-name-input').value = user.name || '';
                    document.getElementById('profile-email').value = user.email || '';
                    
                    // Handle phone with +234 prefix
                    if (user.phone) {
                        const phone = user.phone.replace('+234', '');
                        document.getElementById('profile-phone').value = phone;
                    }
                    
                    document.getElementById('profile-dept').value = user.dept || '';
                    document.getElementById('profile-level').value = user.level || '';
                    document.getElementById('profile-bio').value = user.bio || '';
                    
                    // Privacy settings
                    document.getElementById('hide-email').checked = user.hideEmail || false;
                    document.getElementById('hide-dept').checked = user.hideDept || false;
                    
                    if (user.photo) document.getElementById('profile-pic').src = user.photo;
                    
                    // Check if user is executive
                    const execSnap = await getDocs(query(
                        collection(db, "executives"),
                        where("userId", "==", currentUserId)
                    ));
                    
                    let badges = '';
                    if (!execSnap.empty) {
                        const exec = execSnap.docs[0].data();
                        if (exec.level === 'faculty') {
                            badges += '<span class="gold-badge"><i class="fas fa-crown"></i> Faculty Executive</span>';
                            document.getElementById('executive-post-card')?.classList.remove('hidden');
                        } else if (exec.level === 'department') {
                            badges += '<span class="gold-badge"><i class="fas fa-star"></i> Dept Executive</span>';
                            document.getElementById('executive-post-card')?.classList.remove('hidden');
                        } else if (exec.level === 'course') {
                            badges += '<span class="blue-badge"><i class="fas fa-book-open"></i> Course Rep</span>';
                            document.getElementById('course-rep-upload')?.classList.remove('hidden');
                        }
                    }
                    
                    // Add verification badge
                    if (verifiedUsers.has(currentUserId)) {
                        badges += '<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>';
                        document.getElementById('profile-verification-status').innerHTML = '<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified Student</span>';
                    } else {
                        document.getElementById('profile-verification-status').innerHTML = '<span class="unverified-badge"><i class="fas fa-times-circle"></i> Not Verified</span>';
                    }
                    
                    document.getElementById('profile-badges').innerHTML = badges;
                }
                
                // Load portfolio links
                const appDataSnap = await getDoc(doc(db, "AppData", "Portfolio"));
                if (appDataSnap.exists()) {
                    const data = appDataSnap.data();
                    portfolioUrl = data.url || '';
                    portfolioImage = data.image || '';
                    
                    const linkBtn = document.getElementById('portfolio-link-button');
                    if (linkBtn) linkBtn.href = portfolioUrl || '#';
                    
                    const portfolioLink = document.getElementById('portfolio-link');
                    if (portfolioLink) {
                        portfolioLink.href = portfolioUrl || '#';
                        portfolioLink.innerHTML = `<i class="fas fa-briefcase"></i> Creator's Portfolio`;
                    }
                }
                
            } catch (e) {
                console.error("Error loading profile:", e);
            }
        }
        window.loadProfileData = loadProfileData;

        async function saveProfile() {
            const name = document.getElementById('profile-name-input').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const phoneInput = document.getElementById('profile-phone').value.trim().replace(/^0+/, '');
            const phone = phoneInput ? '+234' + phoneInput : '';
            
            // Validation
            let isValid = true;
            if (!name) {
                document.getElementById('name-error').style.display = 'block';
                document.getElementById('profile-name-input').classList.add('input-error');
                isValid = false;
            } else {
                document.getElementById('name-error').style.display = 'none';
                document.getElementById('profile-name-input').classList.remove('input-error');
            }
            
            if (!isValid) return;
            
            showLoading('save-profile');
            
            try {
                const dept = document.getElementById('profile-dept').value;
                const level = document.getElementById('profile-level').value;
                const bio = document.getElementById('profile-bio').value;
                const hideEmail = document.getElementById('hide-email').checked;
                const hideDept = document.getElementById('hide-dept').checked;
                
                await setDoc(doc(db, "Users", currentUserId), {
                    name, email, phone, dept, level, bio,
                    hideEmail, hideDept,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                showToast('Profile saved successfully!');
                loadProfileData();
            } catch (e) {
                showToast('Error saving profile', 'error');
            } finally {
                hideLoading('save-profile');
            }
        }
        window.saveProfile = saveProfile;

        // Save portfolio links
        async function savePortfolioLinks() {
            const url = document.getElementById('portfolio-url')?.value || document.getElementById('admin-portfolio-url')?.value;
            const image = document.getElementById('portfolio-image')?.value || document.getElementById('admin-portfolio-image')?.value;
            
            if (!url) {
                showToast('Please enter a portfolio URL', 'error');
                return;
            }
            
            try {
                await setDoc(doc(db, "AppData", "Portfolio"), {
                    url, image,
                    updatedAt: serverTimestamp()
                });
                
                portfolioUrl = url;
                portfolioImage = image;
                
                localStorage.setItem('portfolio_url', url);
                localStorage.setItem('portfolio_image', image);
                
                const linkBtn = document.getElementById('portfolio-link-button');
                if (linkBtn) linkBtn.href = url;
                
                const portfolioLink = document.getElementById('portfolio-link');
                if (portfolioLink) {
                    portfolioLink.href = url;
                    portfolioLink.innerHTML = `<i class="fas fa-briefcase"></i> Creator's Portfolio`;
                }
                
                showToast('Portfolio links saved!');
            } catch (e) {
                showToast('Error saving links', 'error');
            }
        }
        window.savePortfolioLinks = savePortfolioLinks;

        // ID Verification Request
        async function requestVerification() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.size > 5 * 1024 * 1024) {
                    showToast('File too large! Max 5MB', 'error');
                    return;
                }
                
                const btn = e.target;
                btn.classList.add('btn-loading');
                btn.disabled = true;
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', 'SLIT-HUB');
                    
                    const res = await fetch('https://api.cloudinary.com/v1_1/ddm87a9p2/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        const userSnap = await getDoc(doc(db, "Users", currentUserId));
                        const userName = userSnap.exists() ? userSnap.data().name : 'Unknown';
                        
                        await setDoc(doc(db, "VerificationRequests", currentUserId), {
                            userId: currentUserId,
                            userName: userName,
                            idImage: data.secure_url,
                            timestamp: serverTimestamp(),
                            status: 'pending'
                        });
                        
                        showToast('ID uploaded! Admin will verify soon.');
                    }
                } catch (e) {
                    showToast('Upload failed', 'error');
                } finally {
                    btn.classList.remove('btn-loading');
                    btn.disabled = false;
                }
            };
            input.click();
        }
        window.requestVerification = requestVerification;

        // Delete Profile
        function confirmDeleteProfile() {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete your profile? This cannot be undone!')) {
                deleteProfile();
            }
        }
        window.confirmDeleteProfile = confirmDeleteProfile;

        async function deleteProfile() {
            try {
                await deleteDoc(doc(db, "Users", currentUserId));
                localStorage.removeItem('slit_user_id');
                showToast('Profile deleted. Refresh page to start fresh.');
                setTimeout(() => window.location.reload(), 2000);
            } catch (e) {
                showToast('Error deleting profile', 'error');
            }
        }
        window.deleteProfile = deleteProfile;

        // ============ MARKETPLACE FUNCTIONS ============
        function showPostProductModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">Sell an Item</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">Title <span class="text-danger">*</span></label>
                            <input type="text" id="product-title" class="input-field" placeholder="e.g., MacBook Pro">
                            <div class="error-message" id="product-title-error">Title is required</div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Description <span class="text-danger">*</span></label>
                            <textarea id="product-desc" class="input-field" rows="3" placeholder="Describe your item..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Price (‚Ç¶) <span class="text-danger">*</span></label>
                            <div class="price-input">
                                <input type="text" id="product-price" class="input-field" placeholder="e.g., 45000" oninput="formatPriceInput(this)">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-bold mb-1">Category</label>
                                <select id="product-category" class="input-field">
                                    <option value="Tech">üíª Tech & Gadgets</option>
                                    <option value="Books">üìö Textbooks</option>
                                    <option value="Fashion">üëï Fashion</option>
                                    <option value="Other">‚ûï Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Condition</label>
                                <select id="product-condition" class="input-field">
                                    <option value="New">New</option>
                                    <option value="Used">Used</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="product-negotiable" class="w-4 h-4"> 
                            <label class="text-sm">Price is negotiable</label>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Location</label>
                            <input type="text" id="product-location" class="input-field" placeholder="e.g., Hostel B">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Phone Number <span class="text-danger">*</span></label>
                            <div class="phone-input-container">
                                <span class="phone-prefix">+234</span>
                                <input type="tel" id="product-phone" class="input-field" placeholder="8012345678">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Photos</label>
                            <input type="file" id="product-image" accept="image/*" class="input-field">
                            <p class="text-xs text-muted mt-1">Max 5MB</p>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button onclick="postProduct(this)" class="btn-primary flex-1" id="post-product-btn">
                                <i class="fas fa-cloud-upload-alt"></i> Post Item
                            </button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showPostProductModal = showPostProductModal;

        function formatPriceInput(input) {
            let value = input.value.replace(/,/g, '');
            if (!isNaN(value) && value !== '') {
                input.value = new Intl.NumberFormat('en-NG').format(value);
            }
        }
        window.formatPriceInput = formatPriceInput;

        async function postProduct(btn) {
            const title = document.getElementById('product-title')?.value.trim();
            const desc = document.getElementById('product-desc')?.value.trim();
            const priceInput = document.getElementById('product-price')?.value.replace(/,/g, '');
            const price = parseInt(priceInput);
            const category = document.getElementById('product-category')?.value;
            const condition = document.getElementById('product-condition')?.value;
            const negotiable = document.getElementById('product-negotiable')?.checked;
            const location = document.getElementById('product-location')?.value.trim();
            const phoneInput = document.getElementById('product-phone')?.value.trim().replace(/^0+/, '');
            const phone = phoneInput ? '+234' + phoneInput : '';
            const file = document.getElementById('product-image')?.files[0];
            
            // Validation
            if (!title) {
                document.getElementById('product-title-error').style.display = 'block';
                return;
            }
            
            if (!price || isNaN(price)) {
                showToast('Please enter a valid price', 'error');
                return;
            }
            
            if (!phone || phone === '+234') {
                showToast('Phone number is required', 'error');
                return;
            }
            
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            try {
                let imageUrl = "https://placehold.co/600x400?text=Product";
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', 'SLIT-HUB');
                    const res = await fetch('https://api.cloudinary.com/v1_1/ddm87a9p2/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    if (res.ok) {
                        const data = await res.json();
                        imageUrl = data.secure_url;
                    }
                }
                
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                const sellerName = userSnap.exists() ? userSnap.data().name : 'Anonymous';
                
                await addDoc(collection(db, "Products"), {
                    Title: title,
                    Description: desc,
                    Price: price,
                    Category: category,
                    Condition: condition,
                    Negotiable: negotiable,
                    Location: location,
                    Phone: phone,
                    ImageURL: imageUrl,
                    SellerId: currentUserId,
                    SellerName: sellerName,
                    CreatedAt: serverTimestamp(),
                    IsSold: false,
                    Rating: 0,
                    ReviewCount: 0
                });
                
                document.querySelector('.modal-overlay')?.remove();
                showToast('Product posted successfully!');
                loadProducts();
                loadMyItems();
            } catch (e) {
                showToast('Error posting product', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
        window.postProduct = postProduct;

        async function loadProducts() {
            const container = document.getElementById('product-grid');
            if (!container) return;
            
            container.innerHTML = '<div class="skeleton h-40 w-full"></div>'.repeat(4);
            
            try {
                const snapshot = await getDocs(query(collection(db, "Products"), orderBy("CreatedAt", "desc")));
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted text-center py-8">No items for sale yet</p>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const avgRating = p.ReviewCount > 0 ? (p.Rating / p.ReviewCount).toFixed(1) : "0";
                    html += `
                        <div class="product-card" onclick="viewProduct('${doc.id}')">
                            <img src="${p.ImageURL}" class="w-full h-40 object-cover">
                            <div class="p-3">
                                <h3 class="font-bold truncate">${p.Title}</h3>
                                <p class="text-primary font-bold">‚Ç¶${formatPrice(p.Price)}</p>
                                <div class="flex items-center gap-1 mt-1">
                                    <i class="fas fa-star text-yellow-500 text-xs"></i>
                                    <span class="text-xs">${avgRating} (${p.ReviewCount || 0})</span>
                                </div>
                                <p class="text-xs text-muted mt-1">${p.Location || 'Campus'}</p>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                console.error("Error loading products:", e);
                container.innerHTML = '<p class="text-danger text-center py-8">Error loading products</p>';
            }
        }
        window.loadProducts = loadProducts;

        // View Product Details with Seller Info and More Products
        async function viewProduct(productId) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            const snap = await getDoc(doc(db, "Products", productId));
            const p = snap.data();
            
            // Get seller info with privacy settings
            const userSnap = await getDoc(doc(db, "Users", p.SellerId));
            const seller = userSnap.exists() ? userSnap.data() : {};
            const isVerified = verifiedUsers.has(p.SellerId);
            
            const avgRating = p.ReviewCount > 0 ? (p.Rating / p.ReviewCount).toFixed(1) : "0";
            const isMyProduct = p.SellerId === currentUserId;
            
            // Get more products from same seller
            const moreProductsSnap = await getDocs(query(
                collection(db, "Products"),
                where("SellerId", "==", p.SellerId),
                where("IsSold", "==", false),
                limit(3)
            ));
            
            let moreProductsHtml = '';
            moreProductsSnap.forEach(doc => {
                if (doc.id !== productId) {
                    const prod = doc.data();
                    moreProductsHtml += `
                        <div class="product-card cursor-pointer" onclick="viewProduct('${doc.id}'); modal.remove()">
                            <img src="${prod.ImageURL}" class="w-full h-24 object-cover">
                            <div class="p-2">
                                <p class="font-bold text-sm truncate">${prod.Title}</p>
                                <p class="text-primary text-sm">‚Ç¶${formatPrice(prod.Price)}</p>
                            </div>
                        </div>
                    `;
                }
            });
            
            // Load reviews with replies
            const reviewsSnap = await getDocs(query(
                collection(db, "Products", productId, "Reviews"),
                orderBy("timestamp", "desc")
            ));
            
            let reviewsHtml = '';
            for (const reviewDoc of reviewsSnap.docs) {
                const r = reviewDoc.data();
                const reviewUserSnap = await getDoc(doc(db, "Users", r.userId));
                const reviewUser = reviewUserSnap.exists() ? reviewUserSnap.data() : {};
                
                let reviewReplies = '';
                const repliesSnap = await getDocs(query(
                    collection(db, "Products", productId, "Reviews", reviewDoc.id, "Replies"),
                    orderBy("timestamp", "desc")
                ));
                
                repliesSnap.forEach(replyDoc => {
                    const reply = replyDoc.data();
                    reviewReplies += `
                        <div class="ml-8 mt-2 p-2 bg-card rounded-lg border border-base">
                            <p class="text-xs font-bold">Seller Response:</p>
                            <p class="text-sm">${reply.text}</p>
                            <p class="text-xs text-muted mt-1">${reply.timestamp ? new Date(reply.timestamp.seconds*1000).toLocaleDateString() : ''}</p>
                        </div>
                    `;
                });
                
                reviewsHtml += `
                    <div class="bg-input p-3 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-sm">${r.userName || 'Anonymous'}</span>
                            <span class="text-xs text-muted">${r.timestamp ? new Date(r.timestamp.seconds*1000).toLocaleDateString() : ''}</span>
                        </div>
                        <div class="flex text-yellow-500 text-xs mb-1">
                            ${'<i class="fas fa-star"></i>'.repeat(r.stars)}${'<i class="far fa-star"></i>'.repeat(5 - r.stars)}
                        </div>
                        <p class="text-sm">${r.text}</p>
                        ${reviewReplies}
                        ${isMyProduct ? `
                            <button onclick="replyToReview('${productId}', '${reviewDoc.id}')" class="text-xs text-primary mt-2 hover:underline">
                                <i class="fas fa-reply"></i> Reply
                            </button>
                        ` : ''}
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content max-w-2xl">
                    <img src="${p.ImageURL}" class="w-full h-64 object-cover rounded-lg mb-4">
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-bold">${p.Title}</h2>
                            <p class="text-muted">${p.Category} ‚Ä¢ ${p.Condition}</p>
                        </div>
                        <p class="text-primary text-2xl font-bold">‚Ç¶${formatPrice(p.Price)}</p>
                    </div>
                    
                    <div class="bg-input p-4 rounded-lg mb-4">
                        <p class="text-sm">${p.Description}</p>
                        ${p.Negotiable ? '<p class="text-xs text-green-600 mt-2">üí∞ Price is negotiable</p>' : ''}
                    </div>
                    
                    <!-- Seller Info -->
                    <div class="flex items-center gap-4 p-4 bg-input rounded-lg mb-4 cursor-pointer" onclick="viewUserProfile('${p.SellerId}')">
                        <img src="${seller.photo || 'https://ui-avatars.com/api/?name=' + (seller.name || 'User')}" class="w-12 h-12 rounded-full">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <p class="font-bold">${seller.name || 'Campus Student'}</p>
                                ${isVerified ? '<span class="verified-badge text-xs py-1"><i class="fas fa-check-circle"></i> Verified</span>' : ''}
                            </div>
                            <div class="flex items-center gap-1">
                                <i class="fas fa-star text-yellow-500 text-xs"></i>
                                <span class="text-xs">${avgRating} (${p.ReviewCount || 0} reviews)</span>
                            </div>
                            <p class="text-xs text-muted">Click to view profile</p>
                        </div>
                        ${!isMyProduct ? `
                            <button onclick="reportUser('${p.SellerId}', event)" class="text-red-500 text-sm">
                                <i class="fas fa-flag"></i> Report
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Contact Buttons -->
                    ${!isMyProduct ? `
                        <div class="flex gap-3 mb-6">
                            <a href="https://wa.me/${p.Phone.replace('+', '')}" target="_blank" class="btn-whatsapp flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                            <a href="tel:${p.Phone}" class="btn-call flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                <i class="fas fa-phone"></i> Call
                            </a>
                        </div>
                    ` : ''}
                    
                    <div class="mb-6">
                        <h3 class="font-bold mb-3">Location & Contact</h3>
                        <p class="text-sm mb-2"><i class="fas fa-map-marker-alt text-muted mr-2"></i>${p.Location || 'Campus'}</p>
                        <p class="text-sm"><i class="fas fa-phone text-muted mr-2"></i>${p.Phone}</p>
                    </div>
                    
                    <!-- More from this seller -->
                    ${moreProductsHtml ? `
                        <div class="mb-6">
                            <h3 class="font-bold mb-3">More from this seller</h3>
                            <div class="grid grid-cols-3 gap-2">
                                ${moreProductsHtml}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Reviews -->
                    <div class="mb-6">
                        <h3 class="font-bold mb-3">Reviews (${p.ReviewCount || 0})</h3>
                        <div class="space-y-3 max-h-60 overflow-y-auto">
                            ${reviewsHtml || '<p class="text-muted text-sm">No reviews yet</p>'}
                        </div>
                    </div>
                    
                    ${!isMyProduct ? `
                        <div class="border-t border-base pt-4">
                            <h3 class="font-bold mb-3">Leave a Review</h3>
                            <div class="star-rating mb-3" id="review-stars">
                                ${[1,2,3,4,5].map(i => `<i class="far fa-star text-2xl" data-rating="${i}"></i>`).join('')}
                            </div>
                            <textarea id="review-text" class="input-field mb-3" rows="2" placeholder="Share your experience..."></textarea>
                            <button onclick="submitReview('${productId}')" class="btn-primary w-full">Submit Review</button>
                        </div>
                    ` : `
                        <div class="flex gap-3">
                            <button onclick="editProduct('${productId}')" class="btn-outline flex-1">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteProduct('${productId}')" class="btn-danger flex-1">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `}
                    
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline w-full mt-4">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Setup star rating
            const stars = document.querySelectorAll('#review-stars i');
            let currentRating = 0;
            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.dataset.rating);
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.remove('far');
                            s.classList.add('fas');
                        } else {
                            s.classList.remove('fas');
                            s.classList.add('far');
                        }
                    });
                });
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.rating);
                });
            });
            window.getCurrentRating = () => currentRating || 5;
        }
        window.viewProduct = viewProduct;

        // Reply to review
        async function replyToReview(productId, reviewId) {
            const reply = prompt('Enter your reply:');
            if (!reply || reply.trim().length < 3) {
                showToast('Please enter a valid reply', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, "Products", productId, "Reviews", reviewId, "Replies"), {
                    text: reply,
                    sellerId: currentUserId,
                    timestamp: serverTimestamp()
                });
                
                showToast('Reply posted!');
                document.querySelector('.modal-overlay')?.remove();
            } catch (e) {
                showToast('Error posting reply', 'error');
            }
        }
        window.replyToReview = replyToReview;

        // View user profile
        async function viewUserProfile(userId) {
            const userSnap = await getDoc(doc(db, "Users", userId));
            const user = userSnap.exists() ? userSnap.data() : {};
            const isVerified = verifiedUsers.has(userId);
            
            // Get user's products
            const productsSnap = await getDocs(query(
                collection(db, "Products"),
                where("SellerId", "==", userId),
                where("IsSold", "==", false),
                limit(6)
            ));
            
            let productsHtml = '';
            productsSnap.forEach(doc => {
                const p = doc.data();
                productsHtml += `
                    <div class="product-card cursor-pointer" onclick="viewProduct('${doc.id}')">
                        <img src="${p.ImageURL}" class="w-full h-24 object-cover">
                        <div class="p-2">
                            <p class="font-bold text-xs truncate">${p.Title}</p>
                            <p class="text-primary text-xs">‚Ç¶${formatPrice(p.Price)}</p>
                        </div>
                    </div>
                `;
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="text-center mb-4">
                        <img src="${user.photo || 'https://ui-avatars.com/api/?name=' + (user.name || 'User')}" class="w-20 h-20 rounded-full mx-auto mb-3">
                        <h2 class="text-xl font-bold">${user.name || 'Anonymous'}</h2>
                        ${isVerified ? '<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified</span>' : ''}
                        ${user.level ? `<p class="text-sm text-muted mt-1">Level ${user.level}</p>` : ''}
                    </div>
                    
                    ${(!user.hideEmail || isAdminMode) && user.email ? `
                        <div class="bg-input p-3 rounded-lg mb-3">
                            <p class="text-sm"><i class="fas fa-envelope text-muted mr-2"></i>${user.email}</p>
                        </div>
                    ` : ''}
                    
                    ${(!user.hideDept || isAdminMode) && user.dept ? `
                        <div class="bg-input p-3 rounded-lg mb-3">
                            <p class="text-sm"><i class="fas fa-building text-muted mr-2"></i>${user.dept}</p>
                        </div>
                    ` : ''}
                    
                    ${user.bio ? `
                        <div class="bg-input p-3 rounded-lg mb-4">
                            <p class="text-sm">${user.bio}</p>
                        </div>
                    ` : ''}
                    
                    ${productsHtml ? `
                        <div class="mb-4">
                            <h3 class="font-bold mb-2">Listings</h3>
                            <div class="grid grid-cols-3 gap-2">
                                ${productsHtml}
                            </div>
                        </div>
                    ` : ''}
                    
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline w-full">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.viewUserProfile = viewUserProfile;

        async function submitReview(productId) {
            const text = document.getElementById('review-text')?.value.trim();
            const stars = window.getCurrentRating ? window.getCurrentRating() : 5;
            
            if (!text || text.length < 10) {
                showToast('Please write at least 10 characters', 'error');
                return;
            }
            
            try {
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                const userName = userSnap.exists() ? userSnap.data().name : 'User';
                
                await addDoc(collection(db, "Products", productId, "Reviews"), {
                    userId: currentUserId,
                    userName: userName,
                    stars: stars,
                    text: text,
                    timestamp: serverTimestamp()
                });
                
                const pRef = doc(db, "Products", productId);
                const pSnap = await getDoc(pRef);
                const pData = pSnap.data();
                
                await updateDoc(pRef, {
                    Rating: (pData.Rating || 0) + stars,
                    ReviewCount: (pData.ReviewCount || 0) + 1
                });
                
                showToast('Review submitted!');
                document.querySelector('.modal-overlay')?.remove();
            } catch (e) {
                showToast('Error submitting review', 'error');
            }
        }
        window.submitReview = submitReview;

        async function editProduct(productId) {
            const snap = await getDoc(doc(db, "Products", productId));
            const p = snap.data();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">Edit Product</h2>
                    <div class="space-y-4">
                        <input type="text" id="edit-title" class="input-field" value="${p.Title}">
                        <textarea id="edit-desc" class="input-field" rows="3">${p.Description}</textarea>
                        <input type="number" id="edit-price" class="input-field" value="${p.Price}">
                        <select id="edit-sold" class="input-field">
                            <option value="false" ${!p.IsSold ? 'selected' : ''}>Available</option>
                            <option value="true" ${p.IsSold ? 'selected' : ''}>Sold</option>
                        </select>
                        <div class="flex gap-3">
                            <button onclick="updateProduct('${productId}')" class="btn-primary flex-1">Update</button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.editProduct = editProduct;

        async function updateProduct(productId) {
            const title = document.getElementById('edit-title').value;
            const desc = document.getElementById('edit-desc').value;
            const price = parseInt(document.getElementById('edit-price').value);
            const isSold = document.getElementById('edit-sold').value === 'true';
            
            try {
                await updateDoc(doc(db, "Products", productId), {
                    Title: title,
                    Description: desc,
                    Price: price,
                    IsSold: isSold
                });
                showToast('Product updated!');
                document.querySelector('.modal-overlay')?.remove();
                loadProducts();
                loadMyItems();
            } catch (e) {
                showToast('Error updating product', 'error');
            }
        }
        window.updateProduct = updateProduct;

        async function deleteProduct(productId) {
            if (confirm('Delete this product?')) {
                try {
                    await deleteDoc(doc(db, "Products", productId));
                    showToast('Product deleted');
                    document.querySelector('.modal-overlay')?.remove();
                    loadProducts();
                    loadMyItems();
                } catch (e) {
                    showToast('Error deleting product', 'error');
                }
            }
        }
        window.deleteProduct = deleteProduct;

        // ============ MY ITEMS (MANAGER) ============
        async function loadMyItems() {
            const container = document.getElementById('my-items-grid');
            if (!container) return;
            
            container.innerHTML = '<div class="skeleton h-20 w-full"></div>'.repeat(3);
            
            try {
                const snapshot = await getDocs(query(
                    collection(db, "Products"),
                    where("SellerId", "==", currentUserId),
                    orderBy("CreatedAt", "desc")
                ));
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted text-center py-8">You have no listings yet</p>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    html += `
                        <div class="card flex items-center gap-4">
                            <img src="${p.ImageURL}" class="w-16 h-16 rounded-lg object-cover">
                            <div class="flex-1">
                                <h3 class="font-bold">${p.Title}</h3>
                                <p class="text-primary font-bold">‚Ç¶${formatPrice(p.Price)}</p>
                                ${p.IsSold ? '<span class="text-xs bg-danger text-white px-2 py-1 rounded">SOLD</span>' : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editProduct('${doc.id}')" class="btn-outline p-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct('${doc.id}')" class="btn-danger p-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                console.error("Error loading my items:", e);
            }
        }
        window.loadMyItems = loadMyItems;

        // ============ SERVICES ============
        function showPostServiceModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">List a Service</h2>
                    <div class="space-y-4">
                        <input type="text" id="service-title" class="input-field" placeholder="Service Title">
                        <select id="service-category" class="input-field">
                            <option value="hair">‚úÇÔ∏è Hair & Beauty</option>
                            <option value="repair">üì± Gadget Repair</option>
                            <option value="photo">üì∏ Photography</option>
                            <option value="tutor">üë®‚Äçüè´ Tutoring</option>
                        </select>
                        <textarea id="service-desc" class="input-field" rows="3" placeholder="Description"></textarea>
                        <input type="text" id="service-price" class="input-field" placeholder="Price (‚Ç¶)">
                        <div class="phone-input-container">
                            <span class="phone-prefix">+234</span>
                            <input type="tel" id="service-phone" class="input-field" placeholder="8012345678">
                        </div>
                        <button onclick="postService(this)" class="btn-primary w-full">List Service</button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline w-full">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showPostServiceModal = showPostServiceModal;

        async function postService(btn) {
            const title = document.getElementById('service-title').value.trim();
            const category = document.getElementById('service-category').value;
            const desc = document.getElementById('service-desc').value.trim();
            const price = document.getElementById('service-price').value.replace(/,/g, '');
            const phoneInput = document.getElementById('service-phone').value.trim().replace(/^0+/, '');
            const phone = phoneInput ? '+234' + phoneInput : '';
            
            if (!title || !desc || !price) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            try {
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                const userName = userSnap.exists() ? userSnap.data().name : 'Anonymous';
                
                await addDoc(collection(db, "services"), {
                    title, category, description: desc, price: parseInt(price), phone,
                    provider: userName,
                    providerId: currentUserId,
                    createdAt: serverTimestamp()
                });
                
                document.querySelector('.modal-overlay')?.remove();
                showToast('Service listed!');
                loadServices();
            } catch (e) {
                showToast('Error listing service', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
        window.postService = postService;

        async function loadServices() {
            const container = document.getElementById('services-grid');
            if (!container) return;
            
            container.innerHTML = '<div class="skeleton h-32 w-full"></div>'.repeat(3);
            
            try {
                const snap = await getDocs(query(collection(db, "services"), orderBy("createdAt", "desc")));
                
                if (snap.empty) {
                    container.innerHTML = '<p class="text-muted text-center py-8">No services listed yet</p>';
                    return;
                }
                
                let html = '';
                snap.forEach(doc => {
                    const s = doc.data();
                    const icons = { hair: '‚úÇÔ∏è', repair: 'üì±', photo: 'üì∏', tutor: 'üë®‚Äçüè´' };
                    html += `
                        <div class="card cursor-pointer hover:shadow-xl" onclick="viewService('${doc.id}')">
                            <div class="flex items-start gap-3">
                                <div class="text-4xl">${icons[s.category] || 'üõ†Ô∏è'}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold">${s.title}</h3>
                                    <p class="text-sm text-muted mb-2">${s.description}</p>
                                    <p class="text-primary font-bold">‚Ç¶${formatPrice(s.price)}</p>
                                    <p class="text-xs text-muted mt-2">${s.provider}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                console.error("Error loading services:", e);
            }
        }
        window.loadServices = loadServices;

        async function viewService(serviceId) {
            const snap = await getDoc(doc(db, "services", serviceId));
            const s = snap.data();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">${s.title}</h2>
                    <div class="bg-input p-4 rounded-lg mb-4">
                        <p class="text-sm">${s.description}</p>
                    </div>
                    <p class="text-primary text-xl font-bold mb-2">‚Ç¶${formatPrice(s.price)}</p>
                    <div class="flex gap-3 mb-4">
                        <a href="https://wa.me/${s.phone.replace('+', '')}" target="_blank" class="btn-whatsapp flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                        <a href="tel:${s.phone}" class="btn-call flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                            <i class="fas fa-phone"></i> Call
                        </a>
                    </div>
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline w-full">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.viewService = viewService;

        // ============ REQUESTS ============
        function showPostRequestModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">Create a Request</h2>
                    <div class="space-y-4">
                        <select id="request-category" class="input-field">
                            <option value="roommate">üè† Roommate</option>
                            <option value="study">üë´ Study Partner</option>
                            <option value="textbook">üìö Textbook</option>
                            <option value="urgent">üöë Urgent</option>
                        </select>
                        <input type="text" id="request-title" class="input-field" placeholder="Title">
                        <textarea id="request-desc" class="input-field" rows="3" placeholder="Description"></textarea>
                        <input type="text" id="request-contact" class="input-field" placeholder="Contact info">
                        <button onclick="postRequest(this)" class="btn-primary w-full">Post Request</button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline w-full">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showPostRequestModal = showPostRequestModal;

        async function postRequest(btn) {
            const category = document.getElementById('request-category').value;
            const title = document.getElementById('request-title').value.trim();
            const desc = document.getElementById('request-desc').value.trim();
            const contact = document.getElementById('request-contact').value.trim();
            
            if (!title || !desc) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            try {
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                const userName = userSnap.exists() ? userSnap.data().name : 'Anonymous';
                
                await addDoc(collection(db, "requests"), {
                    category, title, description: desc, contact,
                    posterName: userName,
                    posterId: currentUserId,
                    createdAt: serverTimestamp()
                });
                
                document.querySelector('.modal-overlay')?.remove();
                showToast('Request posted!');
                loadRequests();
            } catch (e) {
                showToast('Error posting request', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
        window.postRequest = postRequest;

        async function loadRequests() {
            const container = document.getElementById('requests-grid');
            if (!container) return;
            
            container.innerHTML = '<div class="skeleton h-24 w-full"></div>'.repeat(3);
            
            try {
                const snap = await getDocs(query(collection(db, "requests"), orderBy("createdAt", "desc")));
                
                if (snap.empty) {
                    container.innerHTML = '<p class="text-muted text-center py-8">No requests yet</p>';
                    return;
                }
                
                let html = '';
                const icons = { roommate: 'üè†', study: 'üë´', textbook: 'üìö', urgent: 'üöë' };
                
                snap.forEach(doc => {
                    const r = doc.data();
                    html += `
                        <div class="card cursor-pointer hover:shadow-xl" onclick="viewRequest('${doc.id}')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="text-xs font-bold px-2 py-1 rounded-full bg-warning text-white">${icons[r.category] || 'üìå'} ${r.category}</span>
                                    <h3 class="font-bold mt-2">${r.title}</h3>
                                    <p class="text-sm text-muted">${r.description}</p>
                                    <p class="text-xs text-muted mt-2">Posted by ${r.posterName || 'Anonymous'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                console.error("Error loading requests:", e);
            }
        }
        window.loadRequests = loadRequests;

        async function viewRequest(requestId) {
            const snap = await getDoc(doc(db, "requests", requestId));
            const r = snap.data();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">${r.title}</h2>
                    <div class="bg-input p-4 rounded-lg mb-4">
                        <p class="text-sm">${r.description}</p>
                    </div>
                    <p class="text-sm mb-2"><i class="fas fa-phone text-muted mr-2"></i>${r.contact || 'No contact provided'}</p>
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline w-full mt-4">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.viewRequest = viewRequest;

        function filterServices(category) {
            showToast(`Showing ${category} services`);
            loadServices();
        }
        window.filterServices = filterServices;

        function filterRequests(category) {
            showToast(`Showing ${category} requests`);
            loadRequests();
        }
        window.filterRequests = filterRequests;

        // ============ ADMIN FUNCTIONS ============
        function toggleAdminMode() {
            const password = prompt("Enter admin password:");
            if (password === "junior123") {
                isAdminMode = !isAdminMode;
                document.getElementById('admin-panel').classList.toggle('hidden', !isAdminMode);
                document.getElementById('admin-toggle').innerHTML = isAdminMode ? 
                    '<i class="fas fa-lock-open"></i> Admin: ON' : 
                    '<i class="fas fa-lock"></i> Admin: OFF';
                
                if (isAdminMode) {
                    loadAdminData();
                }
            }
        }
        window.toggleAdminMode = toggleAdminMode;

        async function loadAdminData() {
            try {
                await loadVerifiedUsers();
                
                // Load stats
                const deptsSnap = await getDocs(collection(db, "departments"));
                const execsSnap = await getDocs(collection(db, "executives"));
                const usersSnap = await getDocs(collection(db, "Users"));
                const productsSnap = await getDocs(collection(db, "Products"));
                
                document.getElementById('admin-stat-depts').innerText = deptsSnap.size;
                document.getElementById('admin-stat-execs').innerText = execsSnap.size;
                document.getElementById('admin-stat-users').innerText = usersSnap.size;
                document.getElementById('admin-stat-products').innerText = productsSnap.size;
                
                // Load departments dropdowns
                let deptOptions = '<option value="">Select Department</option>';
                deptsSnap.forEach(doc => {
                    const dept = doc.data();
                    deptOptions += `<option value="${doc.id}">${dept.name}</option>`;
                });
                document.getElementById('exec-dept').innerHTML = deptOptions;
                
                // Load departments list
                let deptList = '';
                deptsSnap.forEach(doc => {
                    const dept = doc.data();
                    deptList += `
                        <div class="flex justify-between items-center p-3 bg-input rounded-lg">
                            <div>
                                <span class="font-bold">${dept.name}</span>
                                <span class="text-xs text-muted ml-2">${dept.code}</span>
                            </div>
                            <button onclick="deleteDepartment('${doc.id}')" class="text-danger hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                document.getElementById('depts-list').innerHTML = deptList || '<p class="text-muted">No departments</p>';
                
                // Load executives list
                let execList = '';
                const execsQuery = await getDocs(query(collection(db, "executives"), orderBy("createdAt", "desc")));
                execsQuery.forEach(doc => {
                    const exec = doc.data();
                    const badge = exec.level === 'faculty' ? 'üëë' : exec.level === 'department' ? '‚≠ê' : 'üìò';
                    execList += `
                        <div class="flex justify-between items-center p-3 bg-input rounded-lg">
                            <div>
                                <span class="font-bold">${exec.name}</span>
                                <span class="text-xs ml-2">${badge} ${exec.position}</span>
                                <p class="text-xs text-muted">${exec.email}</p>
                            </div>
                            <button onclick="deleteExecutive('${doc.id}')" class="text-danger hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                document.getElementById('execs-list').innerHTML = execList || '<p class="text-muted">No executives</p>';
                
                // Load member directory with verification status
                let memberHtml = '';
                usersSnap.forEach(doc => {
                    const user = doc.data();
                    const isVerified = verifiedUsers.has(doc.id);
                    memberHtml += `
                        <div class="flex justify-between items-center p-3 bg-input rounded-lg">
                            <div>
                                <p class="font-bold">${user.name || 'Anonymous'}</p>
                                <p class="text-xs text-muted">ID: ${doc.id}</p>
                                ${isVerified ? 
                                    '<span class="verified-badge text-xs"><i class="fas fa-check-circle"></i> Verified</span>' : 
                                    '<span class="unverified-badge text-xs"><i class="fas fa-times-circle"></i> Unverified</span>'}
                            </div>
                            <div class="flex gap-2">
                                ${!isVerified ? `
                                    <button onclick="verifyUserAdmin('${doc.id}')" class="text-success hover:text-green-700" title="Verify User">
                                        <i class="fas fa-check-circle"></i>
                                    </button>
                                ` : `
                                    <button onclick="unverifyUser('${doc.id}')" class="text-warning hover:text-yellow-700" title="Remove Verification">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                `}
                                <button onclick="banUser('${doc.id}')" class="text-danger hover:text-red-700" title="Ban User">
                                    <i class="fas fa-ban"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('member-directory-admin').innerHTML = memberHtml || '<p class="text-muted">No users</p>';
                
                // Load verification requests
                const verifSnap = await getDocs(collection(db, "VerificationRequests"));
                let verifHtml = '';
                verifSnap.forEach(doc => {
                    const req = doc.data();
                    verifHtml += `
                        <div class="flex justify-between items-center p-3 bg-input rounded-lg">
                            <div>
                                <p class="font-bold">${req.userName || 'Unknown'}</p>
                                <p class="text-xs text-muted">ID: ${doc.id}</p>
                            </div>
                            <div class="flex gap-2">
                                <a href="${req.idImage}" target="_blank" class="btn-outline text-xs py-1 px-2">View ID</a>
                                <button onclick="verifyUser('${doc.id}')" class="text-success">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="rejectVerification('${doc.id}')" class="text-danger">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('verification-list').innerHTML = verifHtml || '<p class="text-muted">No verification requests</p>';
                
                // Load reports
                const reportsSnap = await getDocs(collection(db, "Reports"));
                let reportsHtml = '';
                reportsSnap.forEach(doc => {
                    const r = doc.data();
                    reportsHtml += `
                        <div class="p-3 bg-input rounded-lg">
                            <p class="font-bold">Report against: ${r.reportedUser}</p>
                            <p class="text-sm mt-1">${r.reason}</p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="banUser('${r.reportedUser}')" class="btn-danger text-xs py-1 px-3">Ban</button>
                                <button onclick="resolveReport('${doc.id}')" class="btn-success text-xs py-1 px-3">Resolve</button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('reports-list').innerHTML = reportsHtml || '<p class="text-muted">No reports</p>';
                
            } catch (e) {
                console.error("Error loading admin data:", e);
            }
        }
        window.loadAdminData = loadAdminData;

        // Verify user (admin)
        async function verifyUserAdmin(userId) {
            if (confirm(`Verify this user?`)) {
                try {
                    await setDoc(doc(db, "VerifiedUsers", userId), {
                        verifiedAt: serverTimestamp(),
                        verifiedBy: currentUserId
                    });
                    showToast('User verified');
                    loadAdminData();
                    loadVerifiedUsers();
                } catch (e) {
                    showToast('Error verifying user', 'error');
                }
            }
        }
        window.verifyUserAdmin = verifyUserAdmin;

        // Unverify user
        async function unverifyUser(userId) {
            if (confirm(`Remove verification from this user?`)) {
                try {
                    await deleteDoc(doc(db, "VerifiedUsers", userId));
                    showToast('Verification removed');
                    loadAdminData();
                    loadVerifiedUsers();
                } catch (e) {
                    showToast('Error removing verification', 'error');
                }
            }
        }
        window.unverifyUser = unverifyUser;

        async function verifyUser(userId) {
            try {
                await setDoc(doc(db, "VerifiedUsers", userId), {
                    verifiedAt: serverTimestamp(),
                    verifiedBy: currentUserId
                });
                await deleteDoc(doc(db, "VerificationRequests", userId));
                showToast('User verified');
                loadAdminData();
                loadVerifiedUsers();
            } catch (e) {
                showToast('Error verifying user', 'error');
            }
        }
        window.verifyUser = verifyUser;

        async function rejectVerification(requestId) {
            if (confirm('Reject this verification request?')) {
                try {
                    await deleteDoc(doc(db, "VerificationRequests", requestId));
                    showToast('Request rejected');
                    loadAdminData();
                } catch (e) {
                    showToast('Error rejecting request', 'error');
                }
            }
        }
        window.rejectVerification = rejectVerification;

        async function resolveReport(reportId) {
            if (confirm('Mark this report as resolved?')) {
                try {
                    await deleteDoc(doc(db, "Reports", reportId));
                    showToast('Report resolved');
                    loadAdminData();
                } catch (e) {
                    showToast('Error resolving report', 'error');
                }
            }
        }
        window.resolveReport = resolveReport;

        async function addDepartment() {
            const name = document.getElementById('dept-name').value.trim();
            const code = document.getElementById('dept-code').value.trim();
            
            if (!name || !code) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            showLoading('add-dept');
            
            try {
                await addDoc(collection(db, "departments"), {
                    name, code,
                    createdAt: serverTimestamp()
                });
                
                document.getElementById('dept-name').value = '';
                document.getElementById('dept-code').value = '';
                showToast('Department added!');
                loadAdminData();
            } catch (e) {
                showToast('Error adding department', 'error');
            } finally {
                hideLoading('add-dept');
            }
        }
        window.addDepartment = addDepartment;

        async function deleteDepartment(id) {
            if (confirm('Delete this department?')) {
                try {
                    await deleteDoc(doc(db, "departments", id));
                    showToast('Department deleted');
                    loadAdminData();
                } catch (e) {
                    showToast('Error deleting department', 'error');
                }
            }
        }
        window.deleteDepartment = deleteDepartment;

        async function addExecutive() {
            const deptId = document.getElementById('exec-dept').value;
            const name = document.getElementById('exec-name').value.trim();
            const position = document.getElementById('exec-position').value.trim();
            const email = document.getElementById('exec-email').value.trim();
            const level = document.getElementById('exec-level').value;
            const course = document.getElementById('exec-course').value.trim();
            
            if (!deptId || !name || !position || !email) {
                showToast('Please fill required fields', 'error');
                return;
            }
            
            showLoading('add-exec');
            
            try {
                await addDoc(collection(db, "executives"), {
                    departmentId: deptId,
                    name, position, email, level,
                    courseCode: course || null,
                    createdAt: serverTimestamp()
                });
                
                document.getElementById('exec-name').value = '';
                document.getElementById('exec-position').value = '';
                document.getElementById('exec-email').value = '';
                document.getElementById('exec-course').value = '';
                showToast('Executive added!');
                loadAdminData();
            } catch (e) {
                showToast('Error adding executive', 'error');
            } finally {
                hideLoading('add-exec');
            }
        }
        window.addExecutive = addExecutive;

        async function deleteExecutive(id) {
            if (confirm('Remove this executive?')) {
                try {
                    await deleteDoc(doc(db, "executives", id));
                    showToast('Executive removed');
                    loadAdminData();
                } catch (e) {
                    showToast('Error removing executive', 'error');
                }
            }
        }
        window.deleteExecutive = deleteExecutive;

        async function banUser(userId) {
            if (confirm('Ban this user?')) {
                try {
                    await setDoc(doc(db, "BannedUsers", userId), {
                        bannedAt: serverTimestamp(),
                        bannedBy: currentUserId
                    });
                    showToast('User banned');
                    loadAdminData();
                } catch (e) {
                    showToast('Error banning user', 'error');
                }
            }
        }
        window.banUser = banUser;

        async function sendGlobalBroadcast() {
            const msg = document.getElementById('global-broadcast-input').value.trim();
            if (!msg) {
                showToast('Enter a message', 'error');
                return;
            }
            
            try {
                await setDoc(doc(db, "AppData", "Announcement"), {
                    message: msg,
                    active: true,
                    timestamp: serverTimestamp()
                });
                showToast('Broadcast sent!');
                document.getElementById('global-broadcast-input').value = '';
                
                // Show broadcast
                document.getElementById('global-broadcast').classList.remove('hidden');
                document.getElementById('broadcast-message').innerText = msg;
            } catch (e) {
                showToast('Error sending broadcast', 'error');
            }
        }
        window.sendGlobalBroadcast = sendGlobalBroadcast;

        async function deleteGlobalBroadcast() {
            if (confirm('Delete global broadcast?')) {
                try {
                    await setDoc(doc(db, "AppData", "Announcement"), {
                        message: '',
                        active: false
                    });
                    document.getElementById('global-broadcast').classList.add('hidden');
                    showToast('Broadcast deleted');
                } catch (e) {
                    showToast('Error deleting broadcast', 'error');
                }
            }
        }
        window.deleteGlobalBroadcast = deleteGlobalBroadcast;

        // Load global broadcast on startup
        async function loadGlobalBroadcast() {
            try {
                const snap = await getDoc(doc(db, "AppData", "Announcement"));
                if (snap.exists() && snap.data().active) {
                    document.getElementById('global-broadcast').classList.remove('hidden');
                    document.getElementById('broadcast-message').innerText = snap.data().message;
                }
            } catch (e) {
                console.error("Error loading broadcast:", e);
            }
        }

        // ============ CONTACT FUNCTIONS ============
        function showContactAdminModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">Contact Admin</h2>
                    <p class="text-muted mb-4">Your message will be sent to the admin team.</p>
                    <textarea id="admin-message" class="input-field mb-4" rows="4" placeholder="Type your message..."></textarea>
                    <div class="flex gap-3">
                        <button onclick="sendAdminMessage()" class="btn-primary flex-1">Send Message</button>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showContactAdminModal = showContactAdminModal;

        async function sendAdminMessage() {
            const message = document.getElementById('admin-message')?.value.trim();
            if (!message) {
                showToast('Please enter a message', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, "AdminMessages"), {
                    userId: currentUserId,
                    message: message,
                    timestamp: serverTimestamp(),
                    read: false
                });
                document.querySelector('.modal-overlay')?.remove();
                showToast('Message sent to admin!');
            } catch (e) {
                showToast('Error sending message', 'error');
            }
        }
        window.sendAdminMessage = sendAdminMessage;

        function reportUser(userId, event) {
            if (event) event.stopPropagation();
            const reason = prompt('Why are you reporting this user?');
            if (reason) {
                addDoc(collection(db, "Reports"), {
                    reportedUser: userId,
                    reporterUser: currentUserId,
                    reason: reason,
                    timestamp: serverTimestamp()
                }).then(() => showToast('Report sent')).catch(() => showToast('Error sending report', 'error'));
            }
        }
        window.reportUser = reportUser;

        // ============ DARK MODE ============
        function toggleDarkMode() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            localStorage.setItem('dark-mode', html.classList.contains('dark'));
            document.getElementById('dark-icon').className = html.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        }
        window.toggleDarkMode = toggleDarkMode;
        
        if (localStorage.getItem('dark-mode') === 'true') {
            document.documentElement.classList.add('dark');
            document.getElementById('dark-icon').className = 'fas fa-sun';
        }

        // ============ PWA INSTALL ============
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'flex';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('install-btn').style.display = 'none';
            }
        });

        // ============ HELPER FUNCTIONS ============
        async function getDeptName(deptId) {
            if (!deptId) return 'SLIT';
            try {
                const deptSnap = await getDoc(doc(db, "departments", deptId));
                return deptSnap.exists() ? deptSnap.data().name : 'SLIT';
            } catch {
                return 'SLIT';
            }
        }
        window.getDeptName = getDeptName;

        // Load departments
        async function loadDepartments() {
            try {
                const deptsSnap = await getDocs(collection(db, "departments"));
                let options = '<option value="">Select Department</option>';
                deptsSnap.forEach(doc => {
                    const dept = doc.data();
                    options += `<option value="${doc.id}">${dept.name}</option>`;
                });
                
                const deptSelects = ['profile-dept', 'academics-dept', 'exec-dept'];
                deptSelects.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = options;
                });
            } catch (e) {
                console.error("Error loading departments:", e);
            }
        }
        window.loadDepartments = loadDepartments;

        // Load academics data
        async function loadAcademicsData() {
            await loadDepartments();
            
            // Load study groups
            try {
                const groupsSnap = await getDocs(query(collection(db, "studyGroups"), orderBy("createdAt", "desc")));
                let groupsHtml = '';
                groupsSnap.forEach(doc => {
                    const group = doc.data();
                    groupsHtml += `
                        <div class="p-3 bg-input rounded-lg cursor-pointer hover:bg-opacity-80" onclick="joinStudyGroup('${doc.id}')">
                            <div class="flex justify-between items-center">
                                <h4 class="font-bold">${group.name}</h4>
                                <span class="text-xs bg-primary text-white px-2 py-1 rounded">${group.course}</span>
                            </div>
                            <p class="text-sm text-muted mt-1">${group.description}</p>
                            <div class="flex items-center gap-2 mt-2 text-xs">
                                <i class="fas fa-users text-primary"></i>
                                <span>${group.members || 0} members</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('study-groups').innerHTML = groupsHtml || '<p class="text-muted">No study groups yet</p>';
            } catch (e) {
                console.error("Error loading study groups:", e);
            }
            
            // Load materials
            try {
                const materialsSnap = await getDocs(query(collection(db, "courseMaterials"), orderBy("uploadedAt", "desc")));
                let materialsHtml = '';
                materialsSnap.forEach(doc => {
                    const mat = doc.data();
                    materialsHtml += `
                        <div class="p-3 bg-input rounded-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">${mat.title}</h4>
                                    <p class="text-xs text-muted">${mat.course} ‚Ä¢ Uploaded by ${mat.uploaderName || 'Unknown'}</p>
                                </div>
                                <a href="${mat.fileUrl}" target="_blank" class="text-primary hover:underline text-sm">
                                    <i class="fas fa-download"></i> View
                                </a>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('materials-list').innerHTML = materialsHtml || '<p class="text-muted">No materials yet</p>';
            } catch (e) {
                console.error("Error loading materials:", e);
            }
        }
        window.loadAcademicsData = loadAcademicsData;

        // Load community data
        async function loadCommunityData() {
            await loadVerifiedUsers();
            
            // Load executives directory
            try {
                const execsSnap = await getDocs(query(collection(db, "executives"), orderBy("createdAt", "desc")));
                let execsHtml = '';
                execsSnap.forEach(doc => {
                    const exec = doc.data();
                    const badge = exec.level === 'faculty' ? 'üëë' : exec.level === 'department' ? '‚≠ê' : 'üìò';
                    
                    // Get user for verification status
                    const userQuery = await getDocs(query(collection(db, "Users"), where("email", "==", exec.email)));
                    let isVerified = false;
                    let userId = '';
                    if (!userQuery.empty) {
                        userId = userQuery.docs[0].id;
                        isVerified = verifiedUsers.has(userId);
                    }
                    
                    execsHtml += `
                        <div class="flex items-center gap-3 p-3 bg-input rounded-lg cursor-pointer" onclick="${userId ? `viewUserProfile('${userId}')` : ''}">
                            <img src="https://ui-avatars.com/api/?name=${exec.name}&background=10b981&color=fff&size=40" class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <p class="font-bold">${exec.name}</p>
                                    ${isVerified ? '<span class="verified-badge text-xs py-1"><i class="fas fa-check-circle"></i></span>' : ''}
                                </div>
                                <p class="text-xs text-muted">${exec.position} ${badge}</p>
                            </div>
                            ${userId ? `
                                <a href="https://wa.me/${exec.phone || ''}" target="_blank" class="text-green-600">
                                    <i class="fab fa-whatsapp text-xl"></i>
                                </a>
                            ` : ''}
                        </div>
                    `;
                });
                document.getElementById('executives-directory').innerHTML = execsHtml || '<p class="text-muted">No executives listed</p>';
            } catch (e) {
                console.error("Error loading executives:", e);
            }
            
            // Load announcements
            await loadAnnouncements();
        }
        window.loadCommunityData = loadCommunityData;

        // Load announcements
        async function loadAnnouncements(filter = 'all') {
            try {
                let q = query(collection(db, "announcements"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                
                let html = '';
                snap.forEach(doc => {
                    const ann = doc.data();
                    if (filter !== 'all' && ann.category !== filter) return;
                    
                    html += `
                        <div class="card">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-1 rounded-full bg-primary text-white">${ann.category}</span>
                                <span class="text-xs text-muted">${ann.createdAt ? new Date(ann.createdAt.seconds*1000).toLocaleDateString() : ''}</span>
                            </div>
                            <h3 class="font-bold mb-2">${ann.title}</h3>
                            <p class="text-sm text-muted mb-3">${ann.content}</p>
                            ${ann.link ? `<a href="${ann.link}" target="_blank" class="text-primary text-sm hover:underline">üîó View Link</a>` : ''}
                        </div>
                    `;
                });
                document.getElementById('announcements-feed').innerHTML = html || '<p class="text-muted text-center py-8">No announcements</p>';
            } catch (e) {
                console.error("Error loading announcements:", e);
            }
        }
        window.loadAnnouncements = loadAnnouncements;

        // Filter announcements
        function filterAnnouncements(category) {
            loadAnnouncements(category);
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-card', 'border', 'border-base');
            });
            if (event) event.target.classList.add('bg-primary', 'text-white');
        }
        window.filterAnnouncements = filterAnnouncements;

        // Post announcement
        async function postAnnouncement() {
            const category = document.getElementById('announce-category').value;
            const title = document.getElementById('announce-title').value.trim();
            const content = document.getElementById('announce-content').value.trim();
            const link = document.getElementById('announce-link').value.trim();
            const date = document.getElementById('announce-date').value;
            
            if (!title || !content) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            const btn = event.target;
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            try {
                const userSnap = await getDoc(doc(db, "Users", currentUserId));
                const userName = userSnap.exists() ? userSnap.data().name : 'Executive';
                
                await addDoc(collection(db, "announcements"), {
                    category,
                    title,
                    content,
                    link,
                    date,
                    postedBy: currentUserId,
                    postedByName: userName,
                    createdAt: serverTimestamp()
                });
                
                document.getElementById('announce-title').value = '';
                document.getElementById('announce-content').value = '';
                document.getElementById('announce-link').value = '';
                document.getElementById('announce-date').value = '';
                
                showToast('Announcement posted!');
                loadAnnouncements();
            } catch (e) {
                showToast('Error posting announcement', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
        window.postAnnouncement = postAnnouncement;

        // Load marketplace data
        function loadMarketplaceData() {
            loadProducts();
        }
        window.loadMarketplaceData = loadMarketplaceData;

        // Show timetable
        function showTimetable(type) {
            document.getElementById('timetable-container').classList.remove('hidden');
            document.getElementById('timetable-title').innerText = 
                type === 'lecture' ? 'üìñ Lecture Timetable' : 
                type === 'test' ? 'üìù Test Schedule' : 'üìã Exam Timetable';
            
            document.getElementById('timetable-content').innerHTML = `
                <div class="p-4 bg-input rounded-lg">
                    <p class="text-center text-muted">Timetable will be available soon</p>
                    <p class="text-center text-sm text-primary mt-2">Please check with your department</p>
                </div>
            `;
        }
        window.showTimetable = showTimetable;

        function hideTimetable() {
            document.getElementById('timetable-container').classList.add('hidden');
        }
        window.hideTimetable = hideTimetable;

        function showMaterials() {
            showToast('Course materials are displayed below');
        }
        window.showMaterials = showMaterials;

        // Create study group modal
        function showCreateStudyGroupModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">Create Study Group</h2>
                    <div class="space-y-4">
                        <input type="text" id="group-name" class="input-field" placeholder="Group Name">
                        <input type="text" id="group-course" class="input-field" placeholder="Course Code">
                        <textarea id="group-desc" class="input-field" rows="3" placeholder="Description"></textarea>
                        <div class="flex gap-3">
                            <button onclick="createStudyGroup()" class="btn-primary flex-1">Create</button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showCreateStudyGroupModal = showCreateStudyGroupModal;

        // Create study group
        async function createStudyGroup() {
            const name = document.getElementById('group-name').value.trim();
            const course = document.getElementById('group-course').value.trim();
            const desc = document.getElementById('group-desc').value.trim();
            
            if (!name || !course) {
                showToast('Please fill required fields', 'error');
                return;
            }
            
            try {
                await addDoc(collection(db, "studyGroups"), {
                    name,
                    course,
                    description: desc,
                    createdBy: currentUserId,
                    members: 1,
                    createdAt: serverTimestamp()
                });
                
                document.querySelector('.modal-overlay')?.remove();
                showToast('Study group created!');
                loadAcademicsData();
            } catch (e) {
                showToast('Error creating group', 'error');
            }
        }
        window.createStudyGroup = createStudyGroup;

        // Join study group
        async function joinStudyGroup(groupId) {
            try {
                const groupRef = doc(db, "studyGroups", groupId);
                const groupSnap = await getDoc(groupRef);
                const group = groupSnap.data();
                
                await updateDoc(groupRef, {
                    members: (group.members || 0) + 1
                });
                
                showToast('Joined study group!');
            } catch (e) {
                showToast('Error joining group', 'error');
            }
        }
        window.joinStudyGroup = joinStudyGroup;

        // Upload material modal
        function showUploadMaterialModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-bold mb-4">Upload Course Material</h2>
                    <div class="space-y-4">
                        <input type="text" id="material-title" class="input-field" placeholder="Title">
                        <input type="text" id="material-course" class="input-field" placeholder="Course Code">
                        <select id="material-type" class="input-field">
                            <option value="past_question">Past Question</option>
                            <option value="note">Lecture Note</option>
                            <option value="textbook">Textbook</option>
                        </select>
                        <input type="file" id="material-file" accept=".pdf,.doc,.docx,.ppt,.pptx" class="input-field">
                        <div class="flex gap-3">
                            <button onclick="uploadMaterial()" class="btn-primary flex-1">Upload</button>
                            <button onclick="this.closest('.modal-overlay').remove()" class="btn-outline">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showUploadMaterialModal = showUploadMaterialModal;

        // Upload material
        async function uploadMaterial() {
            const title = document.getElementById('material-title').value.trim();
            const course = document.getElementById('material-course').value.trim();
            const type = document.getElementById('material-type').value;
            const file = document.getElementById('material-file').files[0];
            
            if (!title || !course || !file) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showToast('File too large! Max 10MB', 'error');
                return;
            }
            
            const btn = event.target;
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'SLIT-HUB');
                
                const res = await fetch('https://api.cloudinary.com/v1_1/ddm87a9p2/raw/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    const data = await res.json();
                    
                    const userSnap = await getDoc(doc(db, "Users", currentUserId));
                    const userName = userSnap.exists() ? userSnap.data().name : 'User';
                    
                    await addDoc(collection(db, "courseMaterials"), {
                        title,
                        course,
                        type,
                        fileUrl: data.secure_url,
                        uploaderId: currentUserId,
                        uploaderName: userName,
                        uploadedAt: serverTimestamp(),
                        downloads: 0
                    });
                    
                    document.querySelector('.modal-overlay')?.remove();
                    showToast('Material uploaded!');
                    loadAcademicsData();
                }
            } catch (e) {
                showToast('Upload failed', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
        window.uploadMaterial = uploadMaterial;

        function viewAnnouncement(id) {
            showToast('Viewing announcement...');
        }
        window.viewAnnouncement = viewAnnouncement;

        // Load department data (for academics)
        function loadDepartmentData() {
            showToast('Department data loaded');
        }
        window.loadDepartmentData = loadDepartmentData;

        // Show delete all data modal
        function showDeleteAllDataModal() {
            showToast('This feature requires super admin access');
        }
        window.showDeleteAllDataModal = showDeleteAllDataModal;

        // ============ EVENT LISTENER SETUP ============
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Logo click
            document.getElementById('logo-home')?.addEventListener('click', () => switchTab('home'));
            
            // Dark mode toggle
            document.getElementById('dark-mode-toggle')?.addEventListener('click', toggleDarkMode);
            
            // Navigation tabs
            document.querySelectorAll('.tab[data-tab]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Bottom navigation
            document.querySelectorAll('.nav-item[data-nav]').forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.getAttribute('data-nav');
                    switchTab(tabId);
                });
            });
            
            // Home stats cards
            document.querySelectorAll('[data-nav]').forEach(card => {
                card.addEventListener('click', () => {
                    const tabId = card.getAttribute('data-nav');
                    switchTab(tabId);
                });
            });
            
            // Academics cards
            document.querySelectorAll('[data-academics]').forEach(card => {
                card.addEventListener('click', () => {
                    const type = card.getAttribute('data-academics');
                    if (type === 'materials') showMaterials();
                    else showTimetable(type);
                });
            });
            
            // Hide timetable button
            document.getElementById('hide-timetable')?.addEventListener('click', hideTimetable);
            
            // Study group button
            document.getElementById('create-study-group')?.addEventListener('click', showCreateStudyGroupModal);
            
            // Upload material button
            document.getElementById('upload-material')?.addEventListener('click', showUploadMaterialModal);
            
            // Category filters
            document.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const category = btn.getAttribute('data-category');
                    filterAnnouncements(category);
                });
            });
            
            // Publish announcement
            document.getElementById('publish-announcement')?.addEventListener('click', postAnnouncement);
            
            // Marketplace sub-tabs
            document.querySelectorAll('[data-marketplace]').forEach(tab => {
                tab.addEventListener('click', () => {
                    const marketplaceTab = tab.getAttribute('data-marketplace');
                    switchMarketplaceTab(marketplaceTab);
                });
            });
            
            // Sell item button
            document.getElementById('sell-item')?.addEventListener('click', showPostProductModal);
            
            // List service button
            document.getElementById('list-service')?.addEventListener('click', showPostServiceModal);
            
            // New request button
            document.getElementById('new-request')?.addEventListener('click', showPostRequestModal);
            
            // Service category filters
            document.querySelectorAll('[data-service]').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.getAttribute('data-service');
                    filterServices(category);
                });
            });
            
            // Request category filters
            document.querySelectorAll('[data-request]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const category = btn.getAttribute('data-request');
                    filterRequests(category);
                });
            });
            
            // Profile picture upload
            document.getElementById('upload-profile-pic')?.addEventListener('click', () => {
                document.getElementById('profile-upload').click();
            });
            
            document.getElementById('change-profile-pic')?.addEventListener('click', () => {
                document.getElementById('profile-upload').click();
            });
            
            document.getElementById('profile-upload')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', 'SLIT-HUB');
                    
                    const res = await fetch('https://api.cloudinary.com/v1_1/ddm87a9p2/image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        await setDoc(doc(db, "Users", currentUserId), {
                            photo: data.secure_url
                        }, { merge: true });
                        document.getElementById('profile-pic').src = data.secure_url;
                        showToast('Profile photo updated!');
                    }
                } catch (e) {
                    showToast('Upload failed', 'error');
                }
            });
            
            // Save profile button
            document.getElementById('save-profile')?.addEventListener('click', saveProfile);
            
            // Contact admin button
            document.getElementById('contact-admin')?.addEventListener('click', showContactAdminModal);
            
            // Save portfolio button
            document.getElementById('save-portfolio')?.addEventListener('click', savePortfolioLinks);
            
            // Request verification button
            document.getElementById('request-verification')?.addEventListener('click', requestVerification);
            
            // Course rep upload button
            document.getElementById('rep-upload-material')?.addEventListener('click', showUploadMaterialModal);
            
            // Delete profile button
            document.getElementById('delete-profile')?.addEventListener('click', confirmDeleteProfile);
            
            // Add new item button (manager)
            document.getElementById('add-new-item')?.addEventListener('click', () => switchTab('marketplace'));
            
            // Admin toggle button
            document.getElementById('admin-toggle')?.addEventListener('click', toggleAdminMode);
            
            // Admin save portfolio button
            document.getElementById('admin-save-portfolio')?.addEventListener('click', savePortfolioLinks);
            
            // Send broadcast button
            document.getElementById('send-broadcast')?.addEventListener('click', sendGlobalBroadcast);
            
            // Delete broadcast button
            document.getElementById('delete-broadcast')?.addEventListener('click', deleteGlobalBroadcast);
            
            // Add department button
            document.getElementById('add-dept')?.addEventListener('click', addDepartment);
            
            // Add executive button
            document.getElementById('add-exec')?.addEventListener('click', addExecutive);
            
            // Delete all data button
            document.getElementById('delete-all-data')?.addEventListener('click', showDeleteAllDataModal);
            
            console.log('Event listeners setup complete');
        }

        // ============ INITIALIZE ON LOAD ============
        window.onload = async () => {
            console.log('Initializing SLIT-HUB...');
            
            await loadVerifiedUsers();
            await loadGlobalBroadcast();
            await loadDepartments();
            
            // Setup all event listeners
            setupEventListeners();
            
            // Start on home tab
            switchTab('home');
            
            // Check for updates
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.log);
            }
            
            console.log('Initialization complete');
        };

    </script>
</body>
</html>
