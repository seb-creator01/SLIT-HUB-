<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLIT-HUB | Learn. Connect. Trade.</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SLIT-HUB">
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=SH&background=10b981&color=fff&size=192">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #10b981;
            --primary-glow: rgba(16, 185, 129, 0.2);
            --bg: #f8fafc; 
            --card: #ffffff; 
            --text: #1e293b; 
            --text-light: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0; 
            --input-bg: #f1f5f9;
            --nav-text: #64748b;
            
            --level-100: #3b82f6;
            --level-200: #10b981;
            --level-300: #f59e0b;
            --level-400: #ef4444;
            --level-500: #8b5cf6;
        }
        
        html.dark { 
            --bg: #0f172a; 
            --card: #1e293b; 
            --text: #f8fafc; 
            --text-light: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155; 
            --input-bg: #1e293b;
            --nav-text: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            padding-bottom: 90px;
            background-color: var(--bg); 
            color: var(--text); 
            transition: background 0.4s ease, color 0.4s ease; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
        }

        /* Text color classes */
        .text-default { color: var(--text) !important; }
        .text-light { color: var(--text-light) !important; }
        .text-muted { color: var(--text-muted) !important; }
        .bg-card { background-color: var(--card) !important; }
        .border-base { border-color: var(--border) !important; }
        .bg-input { background-color: var(--input-bg) !important; }

        input, textarea, select {
            background-color: var(--input-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-muted) !important;
            opacity: 0.7;
        }

        .brand-logo {
            font-weight: 800;
            letter-spacing: -1.5px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(16, 185, 129, 0.1));
            cursor: pointer;
        }

        /* Welcome Tour */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        .tour-card {
            background: var(--card);
            border-radius: 2rem;
            padding: 2rem;
            max-width: 90%;
            width: 400px;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Badges */
        .gold-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            gap: 4px;
        }

        .gold-check {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            margin-left: 4px;
        }

        .blue-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            gap: 4px;
        }

        /* Notification Badge */
        .app-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid var(--card);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: var(--card);
            border-left: 4px solid #10b981;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideUp 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        /* Level Badges */
        .level-badge {
            display: inline-flex;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            margin-left: 4px;
        }
        .level-100 { background: #3b82f6; }
        .level-200 { background: #10b981; }
        .level-300 { background: #f59e0b; }
        .level-400 { background: #ef4444; }
        .level-500 { background: #8b5cf6; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            white-space: nowrap;
        }
        .tab {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
            background: none;
            border: none;
        }
        .tab:hover {
            background: var(--input-bg);
            color: var(--text);
        }
        .tab.active {
            background: var(--primary);
            color: white;
        }

        .grid-2, .grid-3, .grid-4 {
            display: grid;
            gap: 1rem;
        }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }

        .hidden {
            display: none !important;
        }

        .btn-premium {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white !important;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(16,185,129,0.4);
        }
    </style>
</head>
<body>

    <!-- Welcome Tour (Shown to new users) -->
    <div id="welcome-tour" class="tour-overlay hidden">
        <div class="tour-card">
            <div class="text-6xl mb-4">üëã</div>
            <h2 class="text-2xl font-bold mb-2">Welcome to SLIT-HUB!</h2>
            <p class="text-muted mb-6">Your all-in-one platform for academics, community, and campus trade.</p>
            
            <div id="tour-step-1" class="tour-step">
                <div class="text-4xl mb-3">üìö</div>
                <h3 class="font-bold mb-2">Learn</h3>
                <p class="text-sm text-muted mb-4">Access timetables, past questions, and study groups for your department.</p>
            </div>
            
            <div id="tour-step-2" class="tour-step hidden">
                <div class="text-4xl mb-3">üë•</div>
                <h3 class="font-bold mb-2">Connect</h3>
                <p class="text-sm text-muted mb-4">Follow executives, join your department community, and get important announcements.</p>
            </div>
            
            <div id="tour-step-3" class="tour-step hidden">
                <div class="text-4xl mb-3">üõçÔ∏è</div>
                <h3 class="font-bold mb-2">Trade</h3>
                <p class="text-sm text-muted mb-4">Buy, sell, request services, and find study partners - all on campus.</p>
            </div>
            
            <div id="tour-step-4" class="tour-step hidden">
                <div class="text-4xl mb-3">‚öôÔ∏è</div>
                <h3 class="font-bold mb-2">Get Started</h3>
                <p class="text-sm text-muted mb-4">Complete your profile to unlock all features!</p>
            </div>
            
            <div class="flex justify-between mt-4">
                <button id="tour-prev" class="btn-outline hidden" onclick="prevTourStep()">Previous</button>
                <button id="tour-next" class="btn-premium" onclick="nextTourStep()">Next</button>
                <button id="tour-skip" class="text-muted text-sm" onclick="hideWelcomeTour()">Skip</button>
            </div>
            
            <div class="flex justify-center gap-1 mt-4">
                <span id="dot-1" class="w-2 h-2 bg-primary rounded-full"></span>
                <span id="dot-2" class="w-2 h-2 bg-muted rounded-full"></span>
                <span id="dot-3" class="w-2 h-2 bg-muted rounded-full"></span>
                <span id="dot-4" class="w-2 h-2 bg-muted rounded-full"></span>
            </div>
        </div>
    </div>

    <!-- Update Banner -->
    <div id="update-banner" class="hidden fixed bottom-24 left-4 right-4 bg-primary text-white p-4 rounded-xl shadow-lg z-[10000] animate-slideUp">
        <div class="flex items-center gap-3">
            <i class="fas fa-rocket"></i>
            <span class="font-bold flex-1">New features available!</span>
            <button onclick="updateApp()" class="bg-white text-primary px-4 py-2 rounded-lg text-sm font-bold">Update</button>
            <button onclick="hideUpdateBanner()" class="text-white/80"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-card border-b border-base p-4 backdrop-blur-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="brand-logo text-2xl" onclick="showHome()">SLIT-HUB</h1>
                <p class="text-xs text-muted hidden md:block">Learn. Connect. Trade. ‚Äî Everything SLIT, One Place</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-xl bg-input flex items-center justify-center">
                    <i class="fas fa-moon" id="dark-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 mt-4">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('home')">üè† Home</button>
            <button class="tab" onclick="switchTab('academics')">üìö Learn</button>
            <button class="tab" onclick="switchTab('community')">üë• Connect</button>
            <button class="tab" onclick="switchTab('marketplace')">üõçÔ∏è Trade</button>
            <button class="tab" onclick="switchTab('profile')">üë§ Profile</button>
            <button class="tab" onclick="switchTab('admin')">‚öôÔ∏è Admin</button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4">
        
        <!-- HOME TAB (Dashboard) -->
        <section id="home-tab" class="tab-content">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">Welcome back, <span id="home-user-name">Student</span>!</h2>
                <p class="text-muted" id="home-user-details">SLIT ‚Ä¢ Set your department in profile</p>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-card p-4 rounded-xl border border-base text-center">
                    <div class="text-3xl mb-2">üìö</div>
                    <div class="text-2xl font-bold" id="stat-courses">0</div>
                    <div class="text-xs text-muted">Courses</div>
                </div>
                <div class="bg-card p-4 rounded-xl border border-base text-center">
                    <div class="text-3xl mb-2">üì¢</div>
                    <div class="text-2xl font-bold" id="stat-announcements">0</div>
                    <div class="text-xs text-muted">Announcements</div>
                </div>
                <div class="bg-card p-4 rounded-xl border border-base text-center">
                    <div class="text-3xl mb-2">üõçÔ∏è</div>
                    <div class="text-2xl font-bold" id="stat-items">0</div>
                    <div class="text-xs text-muted">Items for Sale</div>
                </div>
                <div class="bg-card p-4 rounded-xl border border-base text-center">
                    <div class="text-3xl mb-2">üë•</div>
                    <div class="text-2xl font-bold" id="stat-execs">0</div>
                    <div class="text-xs text-muted">Executives</div>
                </div>
            </div>

            <!-- Today's Schedule -->
            <div class="bg-card p-6 rounded-2xl border border-base mb-8">
                <h3 class="font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-day text-primary"></i> Today's Schedule
                </h3>
                <div id="today-schedule" class="space-y-3">
                    <p class="text-muted text-sm">Complete your profile to see your timetable</p>
                </div>
            </div>

            <!-- Latest Announcements -->
            <div class="bg-card p-6 rounded-2xl border border-base">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-bullhorn text-primary"></i> Latest Announcements
                    </h3>
                    <button class="text-sm text-primary" onclick="switchTab('community')">View All ‚Üí</button>
                </div>
                <div id="home-announcements" class="space-y-3">
                    <p class="text-muted text-sm">Loading announcements...</p>
                </div>
            </div>
        </section>

        <!-- ACADEMICS TAB (Learn) -->
        <section id="academics-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">üìö Academics</h2>
                <p class="text-muted">School of Logistics and Innovation Technology</p>
            </div>

            <!-- Department Selector -->
            <div class="bg-card p-4 rounded-xl border border-base mb-6">
                <label class="block text-sm font-bold mb-2">Your Department</label>
                <select id="academics-dept" class="input-field w-full md:w-64" onchange="loadDepartmentData()">
                    <option value="">Select Department</option>
                </select>
            </div>

            <!-- Quick Access Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-card p-4 rounded-xl border border-base text-center cursor-pointer hover:shadow-lg transition" onclick="showTimetable('lecture')">
                    <div class="text-3xl mb-2">üìñ</div>
                    <div class="font-bold">Lectures</div>
                    <div class="text-xs text-muted">Weekly schedule</div>
                </div>
                <div class="bg-card p-4 rounded-xl border border-base text-center cursor-pointer hover:shadow-lg transition" onclick="showTimetable('test')">
                    <div class="text-3xl mb-2">üìù</div>
                    <div class="font-bold">Tests</div>
                    <div class="text-xs text-muted">Upcoming tests</div>
                </div>
                <div class="bg-card p-4 rounded-xl border border-base text-center cursor-pointer hover:shadow-lg transition" onclick="showTimetable('exam')">
                    <div class="text-3xl mb-2">üìã</div>
                    <div class="font-bold">Exams</div>
                    <div class="text-xs text-muted">Exam schedule</div>
                </div>
                <div class="bg-card p-4 rounded-xl border border-base text-center cursor-pointer hover:shadow-lg transition" onclick="showMaterials()">
                    <div class="text-3xl mb-2">üìö</div>
                    <div class="font-bold">Materials</div>
                    <div class="text-xs text-muted">Past questions</div>
                </div>
            </div>

            <!-- Timetable Display -->
            <div id="timetable-container" class="bg-card p-6 rounded-2xl border border-base mb-8 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="timetable-title" class="font-bold">Lecture Timetable</h3>
                    <button onclick="hideTimetable()" class="text-muted"><i class="fas fa-times"></i></button>
                </div>
                <div id="timetable-content" class="space-y-3">
                    <!-- Timetable loads here -->
                </div>
            </div>

            <!-- Study Groups -->
            <div class="bg-card p-6 rounded-2xl border border-base mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-users text-primary"></i> Study Groups
                    </h3>
                    <button class="text-sm text-primary" onclick="createStudyGroup()">+ Create Group</button>
                </div>
                <div id="study-groups" class="space-y-3">
                    <p class="text-muted text-sm">Select your department to see study groups</p>
                </div>
            </div>

            <!-- Course Materials -->
            <div class="bg-card p-6 rounded-2xl border border-base">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-folder-open text-primary"></i> Course Materials
                    </h3>
                    <button class="text-sm text-primary" onclick="uploadMaterial()">+ Upload</button>
                </div>
                <div id="materials-list" class="space-y-3">
                    <p class="text-muted text-sm">Select your department to see materials</p>
                </div>
            </div>
        </section>

        <!-- COMMUNITY TAB (Connect) -->
        <section id="community-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">üë• Connect</h2>
                <p class="text-muted">Stay connected with your department community</p>
            </div>

            <!-- Announcement Categories -->
            <div class="flex gap-2 overflow-x-auto pb-4 mb-6">
                <button class="px-4 py-2 bg-primary text-white rounded-full text-sm font-bold" onclick="filterAnnouncements('all')">All</button>
                <button class="px-4 py-2 bg-card border border-base rounded-full text-sm" onclick="filterAnnouncements('sports')">‚öΩ Sports</button>
                <button class="px-4 py-2 bg-card border border-base rounded-full text-sm" onclick="filterAnnouncements('social')">üéâ Social</button>
                <button class="px-4 py-2 bg-card border border-base rounded-full text-sm" onclick="filterAnnouncements('academic')">üìö Academic</button>
                <button class="px-4 py-2 bg-card border border-base rounded-full text-sm" onclick="filterAnnouncements('media')">üì∏ Media</button>
            </div>

            <!-- Executive Post Card (for executives) -->
            <div id="executive-post-card" class="bg-card p-6 rounded-2xl border border-base mb-6 hidden">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-pen-fancy text-primary text-xl"></i>
                    <span class="font-bold">Post Announcement</span>
                    <span id="executive-badge" class="gold-badge ml-auto"><i class="fas fa-check-circle"></i> Executive</span>
                </div>
                <div class="space-y-3">
                    <select id="announce-category" class="input-field">
                        <option value="sports">‚öΩ Sports</option>
                        <option value="social">üéâ Social</option>
                        <option value="academic">üìö Academic</option>
                        <option value="media">üì∏ Media</option>
                    </select>
                    <input type="text" id="announce-title" placeholder="Title" class="input-field">
                    <textarea id="announce-content" placeholder="Content..." rows="3" class="input-field"></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="announce-link" placeholder="Link (optional)" class="input-field">
                        <input type="date" id="announce-date" class="input-field">
                    </div>
                    <button onclick="postAnnouncement()" class="btn-premium w-full">Publish Announcement</button>
                </div>
            </div>

            <!-- Announcements Feed -->
            <div id="announcements-feed" class="space-y-4 mb-8">
                <!-- Announcements load here -->
            </div>

            <!-- Executives Directory -->
            <div class="bg-card p-6 rounded-2xl border border-base mb-8">
                <h3 class="font-bold mb-4">Department Executives</h3>
                <div id="executives-directory" class="space-y-3">
                    <p class="text-muted text-sm">Select your department to see executives</p>
                </div>
            </div>

            <!-- Media Gallery -->
            <div class="bg-card p-6 rounded-2xl border border-base">
                <h3 class="font-bold mb-4">üì∏ Media Gallery</h3>
                <div id="media-gallery" class="grid grid-cols-3 gap-2">
                    <!-- Media items load here -->
                </div>
            </div>
        </section>

        <!-- MARKETPLACE TAB (Trade) -->
        <section id="marketplace-tab" class="tab-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold">üõçÔ∏è Trade</h2>
                <p class="text-muted">Buy, sell, and request services on campus</p>
            </div>

            <!-- Marketplace Sub-tabs -->
            <div class="flex gap-2 border-b border-base mb-6">
                <button class="px-4 py-2 font-bold text-primary border-b-2 border-primary" onclick="switchMarketplaceTab('shop')">üõí Shop</button>
                <button class="px-4 py-2 text-muted" onclick="switchMarketplaceTab('services')">üõ†Ô∏è Services</button>
                <button class="px-4 py-2 text-muted" onclick="switchMarketplaceTab('requests')">üôã Requests</button>
            </div>

            <!-- Shop Section -->
            <div id="shop-section" class="marketplace-section">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Recent Items</h3>
                    <button class="btn-premium text-sm py-2" onclick="showPostScreen()">+ Sell Item</button>
                </div>
                <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Products load here -->
                </div>
            </div>

            <!-- Services Section -->
            <div id="services-section" class="marketplace-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Campus Services</h3>
                    <button class="btn-premium text-sm py-2" onclick="showServiceForm()">+ List Service</button>
                </div>

                <!-- Service Categories -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-card p-3 rounded-xl border border-base text-center cursor-pointer hover:shadow" onclick="filterServices('hair')">
                        <div class="text-2xl mb-1">‚úÇÔ∏è</div>
                        <div class="text-xs font-bold">Hair & Beauty</div>
                    </div>
                    <div class="bg-card p-3 rounded-xl border border-base text-center cursor-pointer hover:shadow" onclick="filterServices('repair')">
                        <div class="text-2xl mb-1">üì±</div>
                        <div class="text-xs font-bold">Gadget Repair</div>
                    </div>
                    <div class="bg-card p-3 rounded-xl border border-base text-center cursor-pointer hover:shadow" onclick="filterServices('photo')">
                        <div class="text-2xl mb-1">üì∏</div>
                        <div class="text-xs font-bold">Photography</div>
                    </div>
                    <div class="bg-card p-3 rounded-xl border border-base text-center cursor-pointer hover:shadow" onclick="filterServices('tutor')">
                        <div class="text-2xl mb-1">üë®‚Äçüè´</div>
                        <div class="text-xs font-bold">Tutoring</div>
                    </div>
                </div>

                <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Services load here -->
                </div>
            </div>

            <!-- Requests Section -->
            <div id="requests-section" class="marketplace-section hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Community Requests</h3>
                    <button class="btn-premium text-sm py-2" onclick="showRequestForm()">+ New Request</button>
                </div>

                <!-- Request Categories -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-4">
                    <button class="px-3 py-1 bg-primary text-white rounded-full text-xs" onclick="filterRequests('all')">All</button>
                    <button class="px-3 py-1 bg-card border border-base rounded-full text-xs" onclick="filterRequests('roommate')">üè† Roommate</button>
                    <button class="px-3 py-1 bg-card border border-base rounded-full text-xs" onclick="filterRequests('study')">üë´ Study Partner</button>
                    <button class="px-3 py-1 bg-card border border-base rounded-full text-xs" onclick="filterRequests('textbook')">üìö Textbook</button>
                    <button class="px-3 py-1 bg-card border border-base rounded-full text-xs" onclick="filterRequests('urgent')">üöë Urgent</button>
                </div>

                <div id="requests-grid" class="space-y-4">
                    <!-- Requests load here -->
                </div>
            </div>
        </section>

        <!-- PROFILE TAB -->
        <section id="profile-tab" class="tab-content hidden max-w-2xl mx-auto">
            <div class="bg-card p-8 rounded-2xl shadow-xl border border-base">
                <div class="text-center mb-8">
                    <div class="relative inline-block">
                        <img id="profile-pic" src="https://ui-avatars.com/api/?name=User&background=10b981&color=fff&size=128" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg">
                        <button onclick="document.getElementById('profile-upload').click()" class="absolute bottom-0 right-0 bg-primary text-white p-2 rounded-full text-xs border-2 border-white">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    <input type="file" id="profile-upload" class="hidden" accept="image/*">
                    
                    <h2 id="profile-name" class="text-2xl font-bold mt-4">Your Name</h2>
                    <p class="text-sm text-muted">ID: <span id="profile-id"></span></p>
                    
                    <!-- Executive/Course Rep Badges -->
                    <div id="profile-badges" class="flex justify-center gap-2 mt-2">
                        <!-- Badges appear here -->
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Full Name</label>
                        <input type="text" id="profile-name-input" class="input-field">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Email</label>
                        <input type="email" id="profile-email" class="input-field">
                        <p class="text-xs text-muted mt-1">Use same email as executive registration to get badges</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Department</label>
                        <select id="profile-dept" class="input-field">
                            <option value="">Select Department</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Level</label>
                        <select id="profile-level" class="input-field">
                            <option value="">Select Level</option>
                            <option value="100">100 Level</option>
                            <option value="200">200 Level</option>
                            <option value="300">300 Level</option>
                            <option value="400">400 Level</option>
                            <option value="500">500 Level</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold mb-1">Bio</label>
                        <textarea id="profile-bio" rows="3" class="input-field" placeholder="Tell us about yourself..."></textarea>
                    </div>
                    
                    <button onclick="saveProfile()" class="btn-premium w-full">Save Profile</button>
                </div>
            </div>
        </section>

        <!-- ADMIN TAB -->
        <section id="admin-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Admin Dashboard</h2>
                <button onclick="toggleAdminMode()" id="admin-toggle" class="px-4 py-2 bg-card border border-base rounded-xl text-sm">
                    <i class="fas fa-lock"></i> Admin: OFF
                </button>
            </div>

            <!-- Admin Panel (Requires Password) -->
            <div id="admin-panel" class="hidden space-y-6">
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-4 rounded-xl text-white">
                        <div class="text-3xl font-bold" id="admin-stat-depts">0</div>
                        <div class="text-sm opacity-90">Departments</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-4 rounded-xl text-white">
                        <div class="text-3xl font-bold" id="admin-stat-execs">0</div>
                        <div class="text-sm opacity-90">Executives</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-xl text-white">
                        <div class="text-3xl font-bold" id="admin-stat-users">0</div>
                        <div class="text-sm opacity-90">Users</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-4 rounded-xl text-white">
                        <div class="text-3xl font-bold" id="admin-stat-products">0</div>
                        <div class="text-sm opacity-90">Products</div>
                    </div>
                </div>

                <!-- Department Management -->
                <div class="bg-card p-6 rounded-2xl border border-base">
                    <h3 class="font-bold mb-4 text-primary">üèõÔ∏è Department Management</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <input type="text" id="dept-name" placeholder="Department Name (e.g., PMT)" class="input-field">
                        <input type="text" id="dept-code" placeholder="Code (e.g., PMT)" class="input-field">
                        <button onclick="addDepartment()" class="bg-primary text-white px-4 py-2 rounded-xl font-bold">
                            <i class="fas fa-plus mr-2"></i>Add Department
                        </button>
                    </div>
                    
                    <div id="depts-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Departments list -->
                    </div>
                </div>

                <!-- Executive Management -->
                <div class="bg-card p-6 rounded-2xl border border-base">
                    <h3 class="font-bold mb-4 text-yellow-600">‚≠ê Executive Management</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <select id="exec-dept" class="input-field">
                            <option value="">Select Department</option>
                        </select>
                        <input type="text" id="exec-name" placeholder="Full Name" class="input-field">
                        <input type="text" id="exec-position" placeholder="Position (e.g., Director of Social)" class="input-field">
                        <input type="email" id="exec-email" placeholder="Email" class="input-field">
                        <select id="exec-level" class="input-field">
                            <option value="faculty">üëë Faculty Executive</option>
                            <option value="department">‚≠ê Department Executive</option>
                            <option value="course">üìò Course Representative</option>
                        </select>
                        <input type="text" id="exec-course" placeholder="Course Code (if rep)" class="input-field">
                        <button onclick="addExecutive()" class="bg-yellow-500 text-white px-4 py-2 rounded-xl font-bold">
                            <i class="fas fa-plus mr-2"></i>Add Executive
                        </button>
                    </div>
                    
                    <div id="execs-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Executives list -->
                    </div>
                </div>

                <!-- Course Rep Management -->
                <div class="bg-card p-6 rounded-2xl border border-base">
                    <h3 class="font-bold mb-4 text-blue-600">üìò Course Representatives</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <select id="rep-dept" class="input-field">
                            <option value="">Select Department</option>
                        </select>
                        <input type="text" id="rep-course" placeholder="Course Code (e.g., PMT 301)" class="input-field">
                        <input type="text" id="rep-name" placeholder="Student Name" class="input-field">
                        <input type="email" id="rep-email" placeholder="Email" class="input-field">
                        <button onclick="addCourseRep()" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-bold">
                            <i class="fas fa-plus mr-2"></i>Add Course Rep
                        </button>
                    </div>
                </div>

                <!-- Timetable Upload -->
                <div class="bg-card p-6 rounded-2xl border border-base">
                    <h3 class="font-bold mb-4 text-primary">üìÖ Timetable Upload</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="tt-dept" class="input-field">
                            <option value="">Select Department</option>
                        </select>
                        <select id="tt-type" class="input-field">
                            <option value="lecture">üìñ Lecture</option>
                            <option value="test">üìù Test</option>
                            <option value="exam">üìã Exam</option>
                        </select>
                        <input type="text" id="tt-course" placeholder="Course Code" class="input-field">
                        <input type="text" id="tt-day" placeholder="Day (e.g., Monday)" class="input-field">
                        <input type="text" id="tt-time" placeholder="Time (e.g., 10:00-12:00)" class="input-field">
                        <input type="text" id="tt-venue" placeholder="Venue" class="input-field">
                        <button onclick="uploadTimetable()" class="bg-primary text-white px-4 py-2 rounded-xl font-bold col-span-2">
                            <i class="fas fa-upload mr-2"></i>Upload to Timetable
                        </button>
                    </div>
                </div>

                <!-- Verification Requests -->
                <div class="bg-card p-6 rounded-2xl border border-base">
                    <h3 class="font-bold mb-4 text-green-600">‚úÖ Verification Requests</h3>
                    <div id="verification-list" class="space-y-3">
                        <!-- Verification requests -->
                    </div>
                </div>

                <!-- Reports -->
                <div class="bg-card p-6 rounded-2xl border border-base">
                    <h3 class="font-bold mb-4 text-red-600">‚ö†Ô∏è Reports</h3>
                    <div id="reports-list" class="space-y-3">
                        <!-- Reports -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-card border-t border-base py-2 px-4 flex justify-around z-50">
        <button class="nav-item active" onclick="switchTab('home')">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs">Home</span>
        </button>
        <button class="nav-item" onclick="switchTab('academics')">
            <i class="fas fa-book-open text-xl"></i>
            <span class="text-xs">Learn</span>
        </button>
        <button class="nav-item" onclick="switchTab('community')">
            <i class="fas fa-users text-xl"></i>
            <span class="text-xs">Connect</span>
        </button>
        <button class="nav-item" onclick="switchTab('marketplace')">
            <i class="fas fa-store text-xl"></i>
            <span class="text-xs">Trade</span>
        </button>
        <button class="nav-item" onclick="switchTab('profile')">
            <i class="fas fa-user-circle text-xl"></i>
            <span class="text-xs">Profile</span>
        </button>
    </nav>

    <!-- Install Button -->
    <button id="install-btn" class="fixed bottom-20 right-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-3 rounded-full shadow-lg hidden items-center gap-2 z-[9999]">
        <i class="fas fa-download"></i>
        <span class="text-sm font-bold">Install App</span>
    </button>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, query, orderBy, onSnapshot, where, serverTimestamp, doc, getDoc, deleteDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCpsDTN-NTkTFmbwg3T6vv9H4eE_YXQdZA",
            authDomain: "slit-hub.firebaseapp.com",
            projectId: "slit-hub",
            storageBucket: "slit-hub.firebasestorage.app",
            messagingSenderId: "347194010969",
            appId: "1:347194010969:web:a45af2e8d1627ac2593048"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============ GLOBAL VARIABLES ============
        let currentUserId = localStorage.getItem('slit_user_id');
        if (!currentUserId) {
            currentUserId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 9999);
            localStorage.setItem('slit_user_id', currentUserId);
        }

        let isAdminMode = false;
        let unreadCount = 0;
        let lastSeenAnnouncement = parseInt(localStorage.getItem('lastSeenAnnouncement')) || 0;
        let currentUser = {
            name: '',
            email: '',
            dept: '',
            level: '',
            isExecutive: false,
            isCourseRep: false
        };

        // ============ UTILITY FUNCTIONS ============
        function formatPrice(price) {
            return new Intl.NumberFormat('en-NG').format(price);
        }

        // Update app icon badge
        async function updateAppBadge(count) {
            if (navigator.setAppBadge) {
                try {
                    await navigator.setAppBadge(count);
                } catch (err) {
                    console.log('Badge error:', err);
                }
            }
        }

        // Show toast notification
        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-2xl">${type === 'announcement' ? 'üì¢' : 'üîî'}</div>
                    <div class="flex-1">
                        <p class="font-bold">${title}</p>
                        <p class="text-sm text-muted">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-muted">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // ============ WELCOME TOUR ============
        let tourStep = 1;

        window.showWelcomeTour = () => {
            document.getElementById('welcome-tour').classList.remove('hidden');
            tourStep = 1;
            updateTourStep();
        };

        window.hideWelcomeTour = () => {
            document.getElementById('welcome-tour').classList.add('hidden');
            localStorage.setItem('welcome_shown', 'true');
        };

        window.nextTourStep = () => {
            if (tourStep < 4) {
                tourStep++;
                updateTourStep();
            } else {
                hideWelcomeTour();
            }
        };

        window.prevTourStep = () => {
            if (tourStep > 1) {
                tourStep--;
                updateTourStep();
            }
        };

        function updateTourStep() {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`tour-step-${i}`).classList.add('hidden');
                document.getElementById(`dot-${i}`).classList.remove('bg-primary');
                document.getElementById(`dot-${i}`).classList.add('bg-muted');
            }
            
            // Show current step
            document.getElementById(`tour-step-${tourStep}`).classList.remove('hidden');
            document.getElementById(`dot-${tourStep}`).classList.remove('bg-muted');
            document.getElementById(`dot-${tourStep}`).classList.add('bg-primary');
            
            // Update buttons
            document.getElementById('tour-prev').classList.toggle('hidden', tourStep === 1);
            document.getElementById('tour-next').innerText = tourStep === 4 ? 'Get Started' : 'Next';
        }

        // Check if first time user
        if (!localStorage.getItem('welcome_shown')) {
            setTimeout(() => showWelcomeTour(), 1000);
        }

        // ============ TAB SWITCHING ============
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // Find and activate correct tab
            const tabs = document.querySelectorAll('.tab');
            const navItems = document.querySelectorAll('.nav-item');
            
            const tabIndex = {
                'home': 0, 'academics': 1, 'community': 2, 
                'marketplace': 3, 'profile': 4, 'admin': 5
            }[tabId];
            
            if (tabs[tabIndex]) tabs[tabIndex].classList.add('active');
            if (navItems[tabIndex]) navItems[tabIndex].classList.add('active');
            
            // Load tab-specific data
            if (tabId === 'home') loadHomeData();
            if (tabId === 'academics') loadDepartmentsDropdown();
            if (tabId === 'community') loadAnnouncements();
            if (tabId === 'profile') loadProfile();
        };

        window.switchMarketplaceTab = (tab) => {
            document.querySelectorAll('.marketplace-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${tab}-section`).classList.remove('hidden');
            
            if (tab === 'shop') loadProducts();
            if (tab === 'services') loadServices();
            if (tab === 'requests') loadRequests();
        };

        // ============ HOME TAB ============
        async function loadHomeData() {
            // Load user info
            const userSnap = await getDoc(doc(db, "Users", currentUserId));
            if (userSnap.exists()) {
                const user = userSnap.data();
                document.getElementById('home-user-name').innerText = user.name || 'Student';
                document.getElementById('home-user-details').innerHTML = 
                    `${user.dept || 'SLIT'} ‚Ä¢ ${user.level || 'Set level in profile'}`;
            }
            
            // Load stats
            const deptsSnap = await getDocs(collection(db, "departments"));
            const execsSnap = await getDocs(collection(db, "executives"));
            const productsSnap = await getDocs(collection(db, "Products"));
            const announcementsSnap = await getDocs(collection(db, "announcements"));
            
            document.getElementById('stat-courses').innerText = deptsSnap.size;
            document.getElementById('stat-announcements').innerText = announcementsSnap.size;
            document.getElementById('stat-items').innerText = productsSnap.size;
            document.getElementById('stat-execs').innerText = execsSnap.size;
            
            // Load today's schedule (if user has department)
            if (currentUser.dept) {
                const ttSnap = await getDocs(query(
                    collection(db, "timetables"),
                    where("departmentId", "==", currentUser.dept),
                    where("type", "==", "lecture")
                ));
                
                let scheduleHtml = '';
                ttSnap.forEach(doc => {
                    const tt = doc.data();
                    scheduleHtml += `
                        <div class="flex justify-between items-center p-3 bg-input rounded-lg">
                            <div>
                                <span class="font-bold">${tt.course}</span>
                                <span class="text-xs text-muted ml-2">${tt.time}</span>
                            </div>
                            <span class="text-sm">${tt.venue}</span>
                        </div>
                    `;
                });
                document.getElementById('today-schedule').innerHTML = scheduleHtml || '<p class="text-muted">No lectures today</p>';
            }
            
            // Load recent announcements
            const recentAnn = await getDocs(query(
                collection(db, "announcements"),
                orderBy("createdAt", "desc"),
                limit(3)
            ));
            
            let annHtml = '';
            recentAnn.forEach(doc => {
                const ann = doc.data();
                annHtml += `
                    <div class="p-3 bg-input rounded-lg">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-bold ${ann.category === 'sports' ? 'text-green-600' : 'text-primary'}">${ann.category}</span>
                            <span class="text-xs text-muted">${ann.createdAt ? new Date(ann.createdAt.seconds*1000).toLocaleDateString() : ''}</span>
                        </div>
                        <p class="font-bold text-sm">${ann.title}</p>
                    </div>
                `;
            });
            document.getElementById('home-announcements').innerHTML = annHtml || '<p class="text-muted">No recent announcements</p>';
        }

        // ============ PROFILE ============
        window.loadProfile = async () => {
            document.getElementById('profile-id').innerText = currentUserId;
            
            // Load departments dropdown
            const deptsSnap = await getDocs(collection(db, "departments"));
            let deptOptions = '<option value="">Select Department</option>';
            deptsSnap.forEach(doc => {
                const dept = doc.data();
                deptOptions += `<option value="${doc.id}">${dept.name}</option>`;
            });
            document.getElementById('profile-dept').innerHTML = deptOptions;
            
            // Load user data
            const userSnap = await getDoc(doc(db, "Users", currentUserId));
            if (userSnap.exists()) {
                const user = userSnap.data();
                document.getElementById('profile-name').innerText = user.name || 'Your Name';
                document.getElementById('profile-name-input').value = user.name || '';
                document.getElementById('profile-email').value = user.email || '';
                document.getElementById('profile-dept').value = user.dept || '';
                document.getElementById('profile-level').value = user.level || '';
                document.getElementById('profile-bio').value = user.bio || '';
                if (user.photo) document.getElementById('profile-pic').src = user.photo;
                
                // Check if user is executive
                const execSnap = await getDocs(query(
                    collection(db, "executives"),
                    where("userId", "==", currentUserId)
                ));
                
                let badges = '';
                if (!execSnap.empty) {
                    const exec = execSnap.docs[0].data();
                    if (exec.level === 'faculty') {
                        badges += '<span class="gold-badge"><i class="fas fa-crown"></i> Faculty Executive</span>';
                    } else if (exec.level === 'department') {
                        badges += '<span class="gold-badge"><i class="fas fa-star"></i> Dept Executive</span>';
                    } else if (exec.level === 'course') {
                        badges += '<span class="blue-badge"><i class="fas fa-book-open"></i> Course Rep</span>';
                    }
                }
                document.getElementById('profile-badges').innerHTML = badges;
            }
        };

        window.saveProfile = async () => {
            const name = document.getElementById('profile-name-input').value;
            const email = document.getElementById('profile-email').value;
            const dept = document.getElementById('profile-dept').value;
            const level = document.getElementById('profile-level').value;
            const bio = document.getElementById('profile-bio').value;
            
            await setDoc(doc(db, "Users", currentUserId), {
                name, email, dept, level, bio
            }, { merge: true });
            
            alert('Profile saved!');
            loadProfile();
        };

        document.getElementById('profile-upload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Upload to Cloudinary
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'SLIT-HUB');
            
            const res = await fetch('https://api.cloudinary.com/v1_1/ddm87a9p2/image/upload', {
                method: 'POST',
                body: formData
            });
            
            if (res.ok) {
                const data = await res.json();
                await setDoc(doc(db, "Users", currentUserId), {
                    photo: data.secure_url
                }, { merge: true });
                document.getElementById('profile-pic').src = data.secure_url;
            }
        };

        // ============ ANNOUNCEMENTS ============
        window.loadAnnouncements = () => {
            const container = document.getElementById('announcements-feed');
            
            onSnapshot(query(collection(db, "announcements"), orderBy("createdAt", "desc")), (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-muted text-center py-8">No announcements yet</p>';
                    return;
                }
                
                // Count unread for badge
                let newCount = 0;
                const oneDayAgo = Date.now() - 86400000;
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const ann = change.doc.data();
                        const annTime = ann.createdAt ? ann.createdAt.seconds * 1000 : 0;
                        if (annTime > lastSeenAnnouncement && annTime > oneDayAgo) {
                            newCount++;
                            
                            // Show toast for new announcements
                            if (!document.getElementById('community-tab').classList.contains('hidden')) {
                                showToast(ann.title, ann.content.substring(0, 50) + '...', 'announcement');
                            }
                        }
                    }
                });
                
                if (newCount > 0) {
                    unreadCount += newCount;
                    updateAppBadge(unreadCount);
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const ann = doc.data();
                    const date = ann.createdAt ? new Date(ann.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
                    
                    html += `
                        <div class="bg-card p-4 rounded-xl border border-base">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 bg-input rounded-full text-xs font-bold">${ann.category}</span>
                                <span class="text-xs text-muted">${date}</span>
                            </div>
                            <h4 class="font-bold mb-1">${ann.title}</h4>
                            <p class="text-sm text-muted mb-2">${ann.content}</p>
                            <div class="flex items-center gap-2 text-xs">
                                <span class="font-bold">${ann.executiveName || 'Executive'}</span>
                                <span class="gold-check"><i class="fas fa-check"></i></span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        };

        // ============ ADMIN FUNCTIONS ============
        window.toggleAdminMode = () => {
            const password = prompt("Enter admin password:");
            if (password === "junior123") {
                isAdminMode = !isAdminMode;
                document.getElementById('admin-panel').classList.toggle('hidden', !isAdminMode);
                document.getElementById('admin-toggle').innerHTML = isAdminMode ? 
                    '<i class="fas fa-lock-open"></i> Admin: ON' : 
                    '<i class="fas fa-lock"></i> Admin: OFF';
                
                if (isAdminMode) {
                    loadAdminData();
                }
            }
        };

        async function loadAdminData() {
            // Load stats
            const deptsSnap = await getDocs(collection(db, "departments"));
            const execsSnap = await getDocs(collection(db, "executives"));
            const usersSnap = await getDocs(collection(db, "Users"));
            const productsSnap = await getDocs(collection(db, "Products"));
            
            document.getElementById('admin-stat-depts').innerText = deptsSnap.size;
            document.getElementById('admin-stat-execs').innerText = execsSnap.size;
            document.getElementById('admin-stat-users').innerText = usersSnap.size;
            document.getElementById('admin-stat-products').innerText = productsSnap.size;
            
            // Load departments dropdowns
            let deptOptions = '<option value="">Select Department</option>';
            deptsSnap.forEach(doc => {
                const dept = doc.data();
                deptOptions += `<option value="${doc.id}">${dept.name}</option>`;
            });
            document.getElementById('exec-dept').innerHTML = deptOptions;
            document.getElementById('rep-dept').innerHTML = deptOptions;
            document.getElementById('tt-dept').innerHTML = deptOptions;
            
            // Load departments list
            let deptList = '';
            deptsSnap.forEach(doc => {
                const dept = doc.data();
                deptList += `
                    <div class="flex justify-between items-center p-2 bg-input rounded-lg">
                        <span>${dept.name} (${dept.code})</span>
                        <button onclick="deleteDepartment('${doc.id}')" class="text-red-500">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            document.getElementById('depts-list').innerHTML = deptList || '<p class="text-muted">No departments</p>';
            
            // Load executives list
            let execList = '';
            const execsQuery = await getDocs(query(collection(db, "executives"), orderBy("createdAt", "desc")));
            execsQuery.forEach(doc => {
                const exec = doc.data();
                const badge = exec.level === 'faculty' ? 'üëë' : exec.level === 'department' ? '‚≠ê' : 'üìò';
                execList += `
                    <div class="flex justify-between items-center p-2 bg-input rounded-lg">
                        <div>
                            <span class="font-bold">${exec.name}</span>
                            <span class="text-xs ml-2">${badge} ${exec.position}</span>
                        </div>
                        <button onclick="deleteExecutive('${doc.id}')" class="text-red-500">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            document.getElementById('execs-list').innerHTML = execList || '<p class="text-muted">No executives</p>';
        }

        window.addDepartment = async () => {
            const name = document.getElementById('dept-name').value;
            const code = document.getElementById('dept-code').value;
            
            if (!name || !code) {
                alert('Please fill all fields');
                return;
            }
            
            await addDoc(collection(db, "departments"), {
                name, code,
                createdAt: serverTimestamp()
            });
            
            document.getElementById('dept-name').value = '';
            document.getElementById('dept-code').value = '';
            loadAdminData();
        };

        window.deleteDepartment = async (id) => {
            if (confirm('Delete this department?')) {
                await deleteDoc(doc(db, "departments", id));
                loadAdminData();
            }
        };

        window.addExecutive = async () => {
            const deptId = document.getElementById('exec-dept').value;
            const name = document.getElementById('exec-name').value;
            const position = document.getElementById('exec-position').value;
            const email = document.getElementById('exec-email').value;
            const level = document.getElementById('exec-level').value;
            const course = document.getElementById('exec-course').value;
            
            if (!deptId || !name || !position || !email) {
                alert('Please fill required fields');
                return;
            }
            
            await addDoc(collection(db, "executives"), {
                departmentId: deptId,
                name, position, email, level,
                courseCode: course || null,
                createdAt: serverTimestamp()
            });
            
            document.getElementById('exec-name').value = '';
            document.getElementById('exec-position').value = '';
            document.getElementById('exec-email').value = '';
            document.getElementById('exec-course').value = '';
            loadAdminData();
        };

        window.deleteExecutive = async (id) => {
            if (confirm('Remove this executive?')) {
                await deleteDoc(doc(db, "executives", id));
                loadAdminData();
            }
        };

        // ============ TIMETABLE ============
        window.uploadTimetable = async () => {
            const deptId = document.getElementById('tt-dept').value;
            const type = document.getElementById('tt-type').value;
            const course = document.getElementById('tt-course').value;
            const day = document.getElementById('tt-day').value;
            const time = document.getElementById('tt-time').value;
            const venue = document.getElementById('tt-venue').value;
            
            if (!deptId || !course || !day || !time || !venue) {
                alert('Please fill all fields');
                return;
            }
            
            await addDoc(collection(db, "timetables"), {
                departmentId: deptId,
                type, course, day, time, venue,
                createdAt: serverTimestamp()
            });
            
            document.getElementById('tt-course').value = '';
            document.getElementById('tt-day').value = '';
            document.getElementById('tt-time').value = '';
            document.getElementById('tt-venue').value = '';
            alert('Timetable entry added!');
        };

        window.showTimetable = async (type) => {
            const deptId = document.getElementById('academics-dept').value;
            if (!deptId) {
                alert('Please select your department first');
                return;
            }
            
            const container = document.getElementById('timetable-container');
            const title = document.getElementById('timetable-title');
            const content = document.getElementById('timetable-content');
            
            title.innerText = type === 'lecture' ? 'üìñ Lecture Timetable' :
                              type === 'test' ? 'üìù Test Schedule' : 'üìã Exam Timetable';
            
            const ttSnap = await getDocs(query(
                collection(db, "timetables"),
                where("departmentId", "==", deptId),
                where("type", "==", type)
            ));
            
            let html = '';
            ttSnap.forEach(doc => {
                const tt = doc.data();
                html += `
                    <div class="flex justify-between items-center p-3 bg-input rounded-lg">
                        <div>
                            <span class="font-bold">${tt.course}</span>
                            <span class="text-xs text-muted ml-2">${tt.day}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm">${tt.time}</div>
                            <div class="text-xs text-muted">${tt.venue}</div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html || '<p class="text-muted">No schedule found</p>';
            container.classList.remove('hidden');
        };

        window.hideTimetable = () => {
            document.getElementById('timetable-container').classList.add('hidden');
        };

        // ============ INITIAL LOAD ============
        window.onload = () => {
            switchTab('home');
            
            // Check for updates
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.log);
            }
        };

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').style.display = 'flex';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('install-btn').style.display = 'none';
            }
        });

        // Dark mode
        window.toggleDarkMode = () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            localStorage.setItem('dark-mode', html.classList.contains('dark'));
            document.getElementById('dark-icon').className = html.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
        };
        
        if (localStorage.getItem('dark-mode') === 'true') {
            document.documentElement.classList.add('dark');
            document.getElementById('dark-icon').className = 'fas fa-sun';
        }

        // Update banner
        window.hideUpdateBanner = () => {
            document.getElementById('update-banner').classList.add('hidden');
        };
        
        window.updateApp = () => {
            window.location.reload();
        };

        // Placeholder functions
        window.loadDepartmentsDropdown = () => {};
        window.loadProducts = () => {};
        window.loadServices = () => {};
        window.loadRequests = () => {};
        window.showPostScreen = () => alert('Post screen coming soon');
        window.showServiceForm = () => alert('Service form coming soon');
        window.showRequestForm = () => alert('Request form coming soon');
        window.filterServices = () => {};
        window.filterRequests = () => {};
        window.createStudyGroup = () => alert('Study group feature coming soon');
        window.uploadMaterial = () => alert('Upload material feature coming soon');
        window.postAnnouncement = () => alert('Announcement feature coming soon');
        window.filterAnnouncements = () => {};

    </script>
</body>
</html>
