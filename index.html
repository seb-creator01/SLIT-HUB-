<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLIT-HUB | Campus Marketplace</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; }
        .hidden { display: none; }
        .active-nav { color: var(--primary); border-top: 2px solid var(--primary); }
        body { padding-bottom: 70px; background-color: #f8fafc; }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-50 p-4">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600" onclick="showScreen('browse-screen')">SLIT-HUB</h1>
            <div id="search-bar" class="flex-1 mx-4 hidden sm:block">
                <input type="text" id="global-search" placeholder="Search products..." class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4">
        
        <section id="browse-screen" class="screen">
            <div class="flex gap-2 mb-6">
                <select id="category-filter" class="border rounded-lg px-3 py-2 bg-white">
                    <option value="All">All Categories</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Books">Books</option>
                    <option value="Fashion">Fashion</option>
                    <option value="Home">Home</option>
                </select>
            </div>
            <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                </div>
        </section>

        <section id="post-screen" class="screen hidden max-w-lg mx-auto bg-white p-6 rounded-xl shadow">
            <h2 class="text-xl font-bold mb-4">Post New Product</h2>
            <div class="space-y-4">
                <div id="image-preview-container" class="w-full h-48 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden cursor-pointer">
                    <img id="image-preview" class="hidden w-full h-full object-cover">
                    <span id="preview-placeholder" class="text-gray-400">Tap to upload image</span>
                </div>
                <input type="file" id="file-input" accept="image/*" class="hidden">
                <input type="text" id="post-title" placeholder="Product Title" class="w-full border p-2 rounded">
                <textarea id="post-desc" placeholder="Description" class="w-full border p-2 rounded h-24"></textarea>
                
                <div class="flex gap-2">
                    <input type="number" id="post-price" placeholder="Price (₦)" class="w-1/2 border p-2 rounded">
                    <select id="post-negotiable" class="w-1/2 border p-2 rounded text-sm">
                        <option value="Fixed">Fixed Price</option>
                        <option value="Negotiable">Negotiable</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <select id="post-category" class="w-1/2 border p-2 rounded text-sm">
                        <option value="Electronics">Electronics</option>
                        <option value="Books">Books</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                    </select>
                    <select id="post-condition" class="w-1/2 border p-2 rounded text-sm">
                        <option value="New">New</option>
                        <option value="Used - Like New">Used - Like New</option>
                        <option value="Used - Good">Used - Good</option>
                        <option value="Used - Fair">Used - Fair</option>
                    </select>
                </div>

                <input type="tel" id="post-phone" placeholder="Phone Number (for calls)" class="w-full border p-2 rounded">
                <input type="text" id="post-location" placeholder="Campus Location (e.g., Hostel A)" class="w-full border p-2 rounded">
                
                <button id="btn-post" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Post Product</button>
            </div>
        </section>

        <section id="my-items-screen" class="screen hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">My Postings</h2>
                <button onclick="toggleAdminMode()" id="admin-toggle-btn" class="text-[10px] bg-gray-200 px-2 py-1 rounded text-gray-600 font-bold uppercase">Admin Mode: OFF</button>
            </div>
            <div id="my-items-grid" class="grid grid-cols-1 gap-4"></div>
        </section>

        <section id="details-screen" class="screen hidden bg-white rounded-xl shadow-lg overflow-hidden">
            <div id="details-content"></div>
        </section>

        <section id="chats-screen" class="screen hidden">
            <h2 class="text-xl font-bold mb-4">Your Conversations</h2>
            <div id="chats-list" class="space-y-2"></div>
        </section>

        <section id="chatroom-screen" class="screen hidden flex flex-col h-[80vh]">
            <div id="chat-header" class="p-4 border-b font-bold"></div>
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50"></div>
            <div class="p-4 bg-white flex gap-2">
                <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 border rounded-full px-4 py-2">
                <button id="btn-send" class="bg-blue-600 text-white p-2 rounded-full w-10 h-10"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 text-gray-500">
        <button onclick="showScreen('browse-screen')" class="nav-item flex flex-col items-center">
            <i class="fas fa-home text-lg"></i><span class="text-xs">Browse</span>
        </button>
        <button onclick="showScreen('post-screen')" class="nav-item flex flex-col items-center">
            <i class="fas fa-plus-circle text-lg"></i><span class="text-xs">Post</span>
        </button>
        <button onclick="loadMyItems()" class="nav-item flex flex-col items-center">
            <i class="fas fa-user-tag text-lg"></i><span class="text-xs">My Items</span>
        </button>
        <button onclick="showScreen('chats-screen')" class="nav-item flex flex-col items-center">
            <i class="fas fa-comment-dots text-lg"></i><span class="text-xs">Chats</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, where, serverTimestamp, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpsDTN-NTkTFmbwg3T6vv9H4eE_YXQdZA",
            authDomain: "slit-hub.firebaseapp.com",
            projectId: "slit-hub",
            storageBucket: "slit-hub.firebasestorage.app",
            messagingSenderId: "347194010969",
            appId: "1:347194010969:web:a45af2e8d1627ac2593048",
            measurementId: "G-CLFWJSG5H1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Persistent User ID for mobile tracking
        if(!localStorage.getItem('slit_user_id')) {
            localStorage.setItem('slit_user_id', "user_" + Math.floor(Math.random() * 1000000));
        }
        let currentUserId = localStorage.getItem('slit_user_id');
        let activeChatId = null;
        let isAdminMode = false;

        // --- NAVIGATION LOGIC ---
        window.showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        };

        // --- CLOUDINARY UPLOAD ---
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'SLIT-HUB');

            const res = await fetch('https://api.cloudinary.com/v1_1/ddm87a9p2/image/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            return data.secure_url;
        }

        // --- POST PRODUCT LOGIC ---
        const imagePreview = document.getElementById('image-preview');
        const fileInput = document.getElementById('file-input');
        
        document.getElementById('image-preview-container').onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    imagePreview.src = ev.target.result;
                    imagePreview.classList.remove('hidden');
                    document.getElementById('preview-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('btn-post').onclick = async () => {
            const btn = document.getElementById('btn-post');
            btn.disabled = true;
            btn.innerText = "Uploading...";

            try {
                const imageUrl = await uploadToCloudinary(fileInput.files[0]);
                
                await addDoc(collection(db, "Products"), {
                    Title: document.getElementById('post-title').value,
                    Description: document.getElementById('post-desc').value,
                    Price: document.getElementById('post-price').value,
                    Negotiable: document.getElementById('post-negotiable').value,
                    Category: document.getElementById('post-category').value,
                    Condition: document.getElementById('post-condition').value,
                    Phone: document.getElementById('post-phone').value,
                    Location: document.getElementById('post-location').value,
                    ImageURL: imageUrl,
                    CreatedAt: serverTimestamp(),
                    SellerId: currentUserId
                });

                alert("Product posted!");
                showScreen('browse-screen');
            } catch (err) {
                console.error(err);
                alert("Error posting product.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Post Product";
            }
        };

        // --- BROWSE PRODUCTS LOGIC ---
        const renderProducts = (docs, containerId = 'product-grid', isOwner = false) => {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            docs.forEach(docSnap => {
                const p = docSnap.data();
                const card = `
                    <div class="bg-white rounded-lg shadow overflow-hidden relative">
                        <div class="absolute top-2 left-2 bg-blue-600 text-white text-[9px] px-2 py-1 rounded-full uppercase font-bold z-10">${p.Condition || 'Used'}</div>
                        <img src="${p.ImageURL}" class="w-full h-32 object-cover" onclick="viewProduct('${docSnap.id}')">
                        <div class="p-3">
                            <h3 class="font-bold truncate text-sm">${p.Title}</h3>
                            <p class="text-blue-600 font-bold text-sm">₦${p.Price} <span class="text-[10px] text-gray-400 font-normal">(${p.Negotiable || 'Fixed'})</span></p>
                            ${(isOwner || isAdminMode) ? `
                                <button onclick="deleteProduct('${docSnap.id}')" class="mt-2 w-full text-red-500 border border-red-500 py-1 rounded text-xs font-bold">Delete Post</button>
                            ` : `<p class="text-gray-400 text-xs mt-1">${p.Location}</p>`}
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        };

        const loadProducts = () => {
            onSnapshot(query(collection(db, "Products"), orderBy("CreatedAt", "desc")), (snapshot) => {
                renderProducts(snapshot.docs);
            });
        };
        loadProducts();

        // --- ADMIN MODE TOGGLE ---
        window.toggleAdminMode = () => {
            isAdminMode = !isAdminMode;
            const btn = document.getElementById('admin-toggle-btn');
            btn.innerText = `Admin Mode: ${isAdminMode ? 'ON' : 'OFF'}`;
            btn.classList.toggle('bg-red-600');
            btn.classList.toggle('text-white');
            loadMyItems(); // Refresh view
        };

        // --- MY ITEMS LOGIC ---
        window.loadMyItems = () => {
            showScreen('my-items-screen');
            let q;
            if (isAdminMode) {
                // In Admin Mode, fetch ALL products so old ones can be deleted
                q = query(collection(db, "Products"), orderBy("CreatedAt", "desc"));
            } else {
                // Normal mode, fetch only current user items
                q = query(collection(db, "Products"), where("SellerId", "==", currentUserId));
            }
            
            onSnapshot(q, (snapshot) => {
                renderProducts(snapshot.docs, 'my-items-grid', !isAdminMode);
            });
        };

        window.deleteProduct = async (id) => {
            if(confirm("Are you sure you want to delete this listing?")) {
                await deleteDoc(doc(db, "Products", id));
            }
        };

        // --- PRODUCT DETAILS ---
        window.viewProduct = async (id) => {
            const docRef = doc(db, "Products", id);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const p = docSnap.data();
                document.getElementById('details-content').innerHTML = `
                    <img src="${p.ImageURL}" class="w-full max-h-80 object-cover">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h2 class="text-2xl font-bold">${p.Title}</h2>
                            <span class="bg-blue-100 text-blue-600 text-xs px-3 py-1 rounded-full font-bold">${p.Condition || 'Used'}</span>
                        </div>
                        <p class="text-blue-600 text-xl font-bold mb-4">₦${p.Price} <span class="text-sm text-gray-400 font-normal">(${p.Negotiable || 'Fixed'})</span></p>
                        <p class="text-gray-600 mb-6 text-sm">${p.Description}</p>
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg mb-6 text-xs">
                            <div><p class="text-gray-400 font-semibold uppercase">Category</p><p class="font-bold text-sm">${p.Category}</p></div>
                            <div><p class="text-gray-400 font-semibold uppercase">Location</p><p class="font-bold text-sm">${p.Location}</p></div>
                        </div>
                        
                        ${p.SellerId !== currentUserId ? `
                            <div class="flex gap-2">
                                <button onclick="startChat('${p.SellerId}', '${p.Title}')" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg">Message</button>
                                ${p.Phone ? `<a href="tel:${p.Phone}" class="flex-1 bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg text-center">Call Seller</a>` : ''}
                            </div>
                        ` : `<p class="text-center text-gray-400 italic">This is your listing</p>`}
                    </div>
                `;
                showScreen('details-screen');
            }
        };

        // --- CHAT SYSTEM ---
        window.startChat = (sellerId, productTitle) => {
            activeChatId = [currentUserId, sellerId].sort().join("_");
            document.getElementById('chat-header').innerText = `Buying: ${productTitle}`;
            showScreen('chatroom-screen');
            loadMessages();
        };

        function loadMessages() {
            const q = query(collection(db, "Chats", activeChatId, "Messages"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.senderId === currentUserId;
                    container.innerHTML += `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white border rounded-bl-none'} px-4 py-2 rounded-2xl max-w-[85%] text-sm shadow-sm">
                                ${m.messageText}
                            </div>
                        </div>
                    `;
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        document.getElementById('btn-send').onclick = async () => {
            const text = document.getElementById('message-input').value;
            if (!text || !activeChatId) return;
            
            await addDoc(collection(db, "Chats", activeChatId, "Messages"), {
                senderId: currentUserId,
                messageText: text,
                timestamp: serverTimestamp()
            });
            document.getElementById('message-input').value = '';
        };

        // --- SEARCH & FILTER ---
        document.getElementById('global-search').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('#product-grid > div').forEach(card => {
                const title = card.querySelector('h3').innerText.toLowerCase();
                card.style.display = title.includes(term) ? 'block' : 'none';
            });
        };

        document.getElementById('category-filter').onchange = (e) => {
            const cat = e.target.value;
            onSnapshot(collection(db, "Products"), (snapshot) => {
                const filtered = cat === "All" ? snapshot.docs : snapshot.docs.filter(d => d.data().Category === cat);
                renderProducts(filtered);
            });
        };

    </script>
</body>
</html>
